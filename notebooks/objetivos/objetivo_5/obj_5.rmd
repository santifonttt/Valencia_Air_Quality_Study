---
title: "Patrones entre factores"
output:
  pdf_document: default
  html_document: default
date: "2025-05-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(arules, warn.conflicts = FALSE)
library(arulesSequences, warn.conflicts = FALSE)
library(dplyr, warn.conflicts = FALSE)
library(tidyr, warn.conflicts = FALSE)
library(lubridate, warn.conflicts = FALSE)
library(fastDummies)
```


# Pivotar Contaminantes

```{r}
df_cont_orig <- read.csv("../../../data/cleaned/calidad_aire/Calidad_Aire_limpio.csv", stringsAsFactors = FALSE)

df_cont_orig <- df_cont_orig %>%
  mutate(
    FechaHora = as.POSIXct(FechaHora, format = "%Y-%m-%d %H:%M:%S", tz = "Europe/Madrid"),
    hora     = hour(FechaHora)
  )
```

```{r}
colnames(df_cont_orig)
```

```{r}
contaminantes <- c('PM10', 'PM2.5', 'NO', 'NO2', 'NOx', 'SO2', 'O3')
```

```{r}
# Definimoss rangos segun la OMS

breaks_pm10 <- c(-Inf, 54, 154, 354, 424, Inf)
labels_pm10 <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")

breaks_pm25 <- c(-Inf, 9, 35, 125, 225, Inf)
labels_pm25 <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")

breaks_so2 <- c(-Inf, 35, 75, 185, 304, Inf)
labels_so2 <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")

breaks_no <- c(-Inf, 53, 100, 360, 649, Inf)
labels_no <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")

breaks_no2 <- c(-Inf, 53, 100, 360, 649, Inf)
labels_no2 <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")

breaks_nox <- c(-Inf, 30, 60, 120, 240, Inf)
labels_nox <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")

breaks_o3 <- c(-Inf, 54, 70, 85, 105, Inf)
labelso3 <- c("Bueno", "Moderado", "Insalubre", "Muy Insalubre", "Peligroso")
```

```{r}
df_categorias <- df_cont_orig %>%
    mutate(
    PM10_cat = cut(PM10, breaks = breaks_pm10, labels = labels_pm10, right = FALSE),
    PM2.5_cat = cut(PM2.5, breaks = breaks_pm25, labels = labels_pm25, right = FALSE),
    SO2_cat  = cut(SO2,  breaks = breaks_so2,  labels = labels_so2,  right = FALSE),
    NO_cat   = cut(NO,   breaks = breaks_no,   labels = labels_no,   right = FALSE),
    NO2_cat  = cut(NO2,  breaks = breaks_no2,  labels = labels_no2,  right = FALSE),
    NOx_cat  = cut(NOx,  breaks = breaks_nox,  labels = labels_nox,  right = FALSE),
    O3_cat   = cut(O3,   breaks = breaks_o3,   labels = labelso3,    right = FALSE)
  ) %>%
  fastDummies::dummy_cols(
    select_columns         = c("PM10_cat","PM2.5_cat","SO2_cat",
                               "NO_cat","NO2_cat","NOx_cat","O3_cat"),
    remove_selected_columns = TRUE,
    remove_first_dummy      = FALSE
  ) %>%
  dplyr::select(FechaHora, hora, starts_with("PM10_cat_"), starts_with("PM2.5_cat_"),
         starts_with("SO2_cat_"),  starts_with("NO_cat_"),
         starts_with("NO2_cat_"),  starts_with("NOx_cat_"),
         starts_with("O3_cat_"))

head(df_categorias)
```

```{r}
write.csv(df_categorias, file = "../../../data/cleaned/calidad_aire/categorias_contaminantes.csv", row.names = FALSE)
```


# Pivotar Meteorología

```{r}
df <- read.csv("../../../data/cleaned/meteorologia/meteorologia_horaria_limpio.csv", show_col_types = FALSE)

df <- df %>%
  mutate(
    Fecha = as.POSIXct(Fecha, tz = "Europe/Madrid"),
    hora  = as.integer(hora)
  )
```

```{r}
df_qual <- df %>%
  mutate(
    Temp_cat = cut(Temperatura,
                   breaks = c(-Inf, 5, 15, 25, 35, Inf),
                   labels = c("muy_frio", "frio", "templado", "calido", "muy_calido"),
                   right  = FALSE),
    Precip_cat = cut(`Precipitaciones ( mm)`,
                   breaks = c(-Inf, 0, 2, 5, 10, Inf),
                   labels = c("sin_lluvia", "lluvia_ligera", "moderada", "fuerte", "extrema"),
                   right  = FALSE),
    Hum_cat = cut(`Humedad (%)`,
                   breaks = c(-Inf, 30, 60, 90, Inf),
                   labels = c("muy_baja", "media", "alta", "muy_alta"),
                   right  = FALSE),
    Viento_cat = cut(`Velocidad del viento (Km/h)`,
                   breaks = c(-Inf, 5, 15, 30, 50, Inf),
                   labels = c("calma", "flojo", "moderado", "fuerte", "temporal"),
                   right  = FALSE),
    Rafaga_cat = cut(`Ráfaga de viento (Km/h)`,
                   breaks = c(-Inf, 10, 25, 50, 75, Inf),
                   labels = c("calma", "floja", "moderada", "fuerte", "temporal"),
                   right  = FALSE),
    Rumbo_cat = cut(`Ángulo del viento (°)`,
                   breaks  = seq(0, 360, by = 45),
                   include.lowest = TRUE,
                   labels  = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")),
    Nubo_cat = cut(`Nubosidad (%)`,
                   breaks = c(-Inf, 10, 50, 90, Inf),
                   labels = c("despejado", "parcial", "nuboso", "cubierto"),
                   right  = FALSE),
    Visib_cat = cut(`Visibilidad ( Km)`,
                   breaks = c(-Inf, 2, 5, 10, Inf),
                   labels = c("mala", "media", "buena", "excelente"),
                   right  = FALSE)
  )
```

```{r}
num_to_remove <- c("Temperatura", "Precipitaciones ( mm)", "Humedad (%)",
                   "Velocidad del viento (Km/h)", "Ráfaga de viento (Km/h)",
                   "Ángulo del viento (°)", "Nubosidad (%)", "Visibilidad ( Km)")

df_qual <- df_qual %>%
  select(-all_of(num_to_remove))
```

```{r}
df_dummies <- dummy_cols(
  df_qual,
  select_columns = c("Temp_cat", "Precip_cat", "Hum_cat", "Viento_cat",
                     "Rafaga_cat", "Rumbo_cat", "Nubo_cat",
                     "Visib_cat", "Tiempo", "Dirección del viento"),
  remove_selected_columns = TRUE,
  remove_first_dummy      = FALSE
)
```

```{r}
write.csv(df_dummies, "../../../data/cleaned/meteorologia/meteorologia_horaria_intervalos.csv")
```


# Pivotar tráfico


# Cruce de bases de datos

## Contaminantes con Meteorología

```{r}
# Lectura de los CSV
df_meteo <- read.csv("../../../data/cleaned/meteorologia/meteorologia_horaria_intervalos.csv", stringsAsFactors = FALSE)
df_cont  <- read.csv("../../../data/cleaned/calidad_aire/categorias_contaminantes.csv", stringsAsFactors = FALSE)
```


```{r}
# Filtrado 2023 y creación de 'fecha' y 'hora'
df_meteo_23 <- df_meteo %>%
  mutate(fecha = as.Date(fecha), 
         year = year(fecha),
         month = month(fecha)) %>%
  filter(year == 2023, month == 4) %>%
  mutate(fecha = format(fecha, "%Y-%m-%d")) %>%
  select(-year, -month)

df_cont_23 <- df_cont %>%
  mutate(
    FechaHora = ymd_hms(FechaHora),
    year      = year(FechaHora),
    month     = month(FechaHora),
    fecha     = format(FechaHora, "%Y-%m-%d"),
    hora      = hour(FechaHora)
  ) %>%
  filter(year == 2023, month == 4) %>%
  select(-FechaHora, -year, -month)
```


Vamos a eliminar las columnas cuyo valor máximo sea 0, ya que no aportan información y así será más eficiente el algoritmo apriori para calcular las reglas.

```{r}
df_cont_23 <- df_cont_23  %>%
  select(where(~ max(.) > 0))

df_meteo_23 <- df_meteo_23 %>%
  select(where(~ max(.) > 0))

summary(df_cont_23$hora)
```


```{r}
# Eliminar las filas de df_meteo en las que hora == 0
df_meteo_23 <- df_meteo_23 %>%
  filter(hora != 0)

# Unión inner por fecha y hora
df_mc <- inner_join(df_cont_23, df_meteo_23, by = c("fecha","hora"))
```


# Reglas de asociación

## Contaminantes con meteorología

En primer lugar vamos a eliminar las columnas de fecha y hora, ya que no son necesarias para el análisis de reglas de asociación.

```{r}
df_mc_2 = df_mc
# Eliminar columnas de fecha y hora
df_mc_2 <- df_mc_2 %>%
  select(-c(fecha, hora))
```

Ahora comprobaremos que no haya columnas con un único valor.

```{r}
uniqs <- sapply(df_mc_2, function(x) length(unique(x)))
df_mc_3 <- df_mc_2[, uniqs > 1]
```

Ahora pasamos a categóricas las variables que van a ser el consecuente. Estas son:

- $NO_2$
- $NO$
- $NO_x$
- $O_3$
- $PM_{2.5}$
- $PM_{10}$

El resto de variables, que serán el antecendente, las convertiremos a varaibles lógicas.

```{r}
df_mc_3[,1:21] = lapply(df_mc_3[,1:21], as.factor)
df_mc_3[,22:ncol(df_mc_3)] = df_mc_3[,22:ncol(df_mc_3)] == 1
```

```{r}
antecedentes = names(df_mc_3)[22:ncol(df_mc_3)]

nombres_consecuentes = names(df_mc_3)[1:21]
crear_consecuentes = function(nombres) {paste0(nombres, "=1")}

consecuentes = crear_consecuentes(nombres_consecuentes)
```

Ya podemos crear las reglas de asociación

```{r}
reglas = apriori(
  df_mc_3, parameter = list(support = 0.1, confidence = 0.8, minlen=2),
  appearance = list(lhs = antecedentes, rhs = consecuentes)
)
```

```{r}
# Eliminar reglas redundantes
reglas2 = reglas[!is.redundant(x = reglas, measure = "confidence")]
# Filtrar reglas con lift > 1.1
filtradas = arules::subset(reglas2, subset = lift > 1.1)
```

```{r}
# Inspección de las reglas filtradas
inspect(sort(filtradas, by = "confidence"))
```

## Reglas de asociación temporales

```{r}
# Secuencia de IDs
df_mc = df_mc %>%
  mutate(
    sequenceID = as.integer(as.factor(fecha)),
    eventID    = hora
  )
```


```{r}
# Pivotar a filas de ítems
items_mc <- grep("PM2\\.5_cat|NO2_cat|Temp_cat|Viento_cat|Hum_cat", names(df_mc), value = TRUE)
long_mc <- df_mc %>%
  pivot_longer(cols      = all_of(items_mc),
               names_to  = "item",
               values_to = "value") %>%
  filter(value == 1) %>%
  select(sequenceID, eventID, item)
```


```{r}
# Crear baskets
baskets_mc <- long_mc %>%
  arrange(sequenceID, eventID) %>%
  group_by(sequenceID, eventID) %>%
  summarise(
    SIZE  = n(),
    items = list(item),
    .groups = "drop"
  )
```


```{r}
# Conversión en memoria a 'transactions'
# Crear lista: cada elemento es vector de ítems, nombre 'seq.event'
tranList_mc <- setNames(baskets_mc$items,
                        paste(baskets_mc$sequenceID, baskets_mc$eventID, sep="."))
# Eliminar duplicados implícitos
tranList_mc <- lapply(tranList_mc, unique)
# Convertir a transactions
txns_mc <- as(tranList_mc, "transactions")
# Asignar transactionInfo directamente
transactionInfo(txns_mc) <- data.frame(
  sequenceID = baskets_mc$sequenceID,
  eventID    = baskets_mc$eventID
)

```


```{r}
# Patrones secuenciales y reglas
seqs_mc  <- cspade(txns_mc,
                   parameter = list(support=0.3, maxsize=3, maxgap=1),
                   control   = list(memsize=8192, verbose=TRUE, tidLists=FALSE))
rules_mc <- ruleInduction(seqs_mc,
                          transactions = txns_mc,
                          confidence   = 0.8,
                          appearance   = list(
    lhs  = grep("^(Temp|Viento|PM2\\.5|NO2)_cat_", itemLabels(txns_mc), value=TRUE),
    rhs  = grep("^cont_cat_", itemLabels(txns_mc),                  value=TRUE)
  ),
                          control      = list(maxlen=2, minlen=2, memsize=8192))
```


```{r}
# Inspección
inspect(sort(rules_mc, by = "confidence"))
```

