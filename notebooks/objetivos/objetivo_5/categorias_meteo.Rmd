---
title: "Transformación de datos"
output: html_document
date: "2025-05-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
############################################################
#  Script: transformar_meteo_a_dummies.R                    #
#  Objetivo: Convertir base HORARIA limpia (df) en          #
#            variables cualitativas codificadas con dummies #
#            **Manteniendo `hora` y `Fecha` originales**    #
############################################################

# ----------------------------------------------------------
# 0. Paquetes ----------------------------------------------
# ----------------------------------------------------------
required_pkgs <- c("dplyr", "fastDummies", "lubridate", "readr")
new_pkgs <- required_pkgs[!(required_pkgs %in% installed.packages()[, "Package"])]
if (length(new_pkgs)) install.packages(new_pkgs)

library(dplyr)
library(fastDummies)
library(lubridate)
library(readr)   # read_csv()

# ----------------------------------------------------------
# 1. Carga del data frame limpio ---------------------------
#    Ajusta la ruta/nombre de archivo a tu caso.            #
#    Por defecto: 'meteorologia_horaria_limpia.csv'         #
# ----------------------------------------------------------
# Si ya has cargado tu data frame en el entorno con otro
# nombre, asígnalo simplemente a `df`, p. ej. df <- mi_df


df <- read_csv("meteorologia_horaria_limpio.csv", show_col_types = FALSE)


stopifnot(is.data.frame(df))   # aborta si df no es data.frame

# ------------------------- Aseguramos tipos ---------------
# Suponemos columnas `Fecha` y `hora` (cambia si difieren).
# `hora` en 0‑23, `Fecha` en zona horaria Europe/Madrid.

df <- df |>
  mutate(
    Fecha = as.POSIXct(Fecha, tz = "Europe/Madrid"),
    hora  = as.integer(hora)
  )

# ----------------------------------------------------------
# 2. Conversión numérico → categórico ----------------------
#    *`hora` y `Fecha` NO se modifican*                     #
# ----------------------------------------------------------

df_qual <- df |>
  mutate(
    # --- Temperatura --------------------------------------
    Temp_cat = cut(Temperatura,
                   breaks = c(-Inf, 5, 15, 25, 35, Inf),
                   labels = c("muy_frio", "frio", "templado", "calido", "muy_calido"),
                   right  = FALSE),

    # --- Precipitación ------------------------------------
    Precip_cat = cut(`Precipitaciones ( mm)`,
                   breaks = c(-Inf, 0, 2, 5, 10, Inf),
                   labels = c("sin_lluvia", "lluvia_ligera", "moderada", "fuerte", "extrema"),
                   right  = FALSE),

    # --- Humedad ------------------------------------------
    Hum_cat = cut(`Humedad (%)`,
                   breaks = c(-Inf, 30, 60, 90, Inf),
                   labels = c("muy_baja", "media", "alta", "muy_alta"),
                   right  = FALSE),

    # --- Velocidad del viento -----------------------------
    Viento_cat = cut(`Velocidad del viento (Km/h)`,
                   breaks = c(-Inf, 5, 15, 30, 50, Inf),
                   labels = c("calma", "flojo", "moderado", "fuerte", "temporal"),
                   right  = FALSE),

    # --- Ráfaga de viento ---------------------------------
    Rafaga_cat = cut(`Ráfaga de viento (Km/h)`,
                   breaks = c(-Inf, 10, 25, 50, 75, Inf),
                   labels = c("calma", "floja", "moderada", "fuerte", "temporal"),
                   right  = FALSE),

    # --- Ángulo del viento → rumbos -----------------------
    Rumbo_cat = cut(`Ángulo del viento (°)`,
                   breaks  = seq(0, 360, by = 45),
                   include.lowest = TRUE,
                   labels  = c("N", "NE", "E", "SE", "S", "SW", "W", "NW")),

    # --- Nubosidad ----------------------------------------
    Nubo_cat = cut(`Nubosidad (%)`,
                   breaks = c(-Inf, 10, 50, 90, Inf),
                   labels = c("despejado", "parcial", "nuboso", "cubierto"),
                   right  = FALSE),

    # --- Visibilidad --------------------------------------
    Visib_cat = cut(`Visibilidad ( Km)`,
                   breaks = c(-Inf, 2, 5, 10, Inf),
                   labels = c("mala", "media", "buena", "excelente"),
                   right  = FALSE)
  )

# ----------------------------------------------------------
# 3. Eliminamos numéricas originales (excepto hora/Fecha) --
# ----------------------------------------------------------
num_to_remove <- c("Temperatura", "Precipitaciones ( mm)", "Humedad (%)",
                   "Velocidad del viento (Km/h)", "Ráfaga de viento (Km/h)",
                   "Ángulo del viento (°)", "Nubosidad (%)", "Visibilidad ( Km)")

df_qual <- df_qual |>
  select(-all_of(num_to_remove))

# ----------------------------------------------------------
# 4. One‑hot encoding (dummies) -----------------------------
#    `hora` y `Fecha` se conservan tal cual                  #
# ----------------------------------------------------------

df_dummies <- dummy_cols(
  df_qual,
  select_columns = c("Temp_cat", "Precip_cat", "Hum_cat", "Viento_cat",
                     "Rafaga_cat", "Rumbo_cat", "Nubo_cat",
                     "Visib_cat", "Tiempo", "Dirección del viento"),
  remove_selected_columns = TRUE,
  remove_first_dummy      = FALSE
)

# ----------------------------------------------------------
# 5. Guardar resultado ------------------------------------
# ----------------------------------------------------------
write_csv(df_dummies, "meteorologia_horaria_dummies.csv")
saveRDS(df_dummies,  "meteorologia_horaria_dummies.rds")

```

