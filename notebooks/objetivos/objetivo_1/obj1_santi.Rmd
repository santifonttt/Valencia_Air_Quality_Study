---
title: "Estudio Contaminantes Santi"
output: html_document
date: "2025-05-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(naniar)
library(lubridate)
library(zoo)
library(stringr)
library(emmeans)
library(car)
library(rstatix)
library(ggpubr)
library(lmtest)
```


Aqui vamos a estudiar los contaminantes individualmente.

Primero de todo, vamos a cargar la base de datos.

```{r}
df <- read.csv("~/Documents/Drive/UPV/Segundo/2ºCuatri/Proyecto/base_para_obj1.csv", stringsAsFactors = FALSE)
```

Ahora que ya sabemos la distribución de los datos, es decir en que años y que estaciones se miden (documento de prep_csv_obj1), vamos a empezar el analisis de los contaminantes, exclusivamente. Me refiero a que vamos a estudiar las siguientes variables:

- `NO2`
- `NO`
- `NOx`
- `O3`
- `SO2`
- `PM10`
- `PM2.5`
- `CO`

Ahora, vamos a ir contaminante a contaminante analizandolos.

## PM10

Primero de todo vamos a ver la distribución de los datos de PM10.

```{r}
hist(df$PM10, breaks = 30, col = "skyblue", main = "Histograma de PM10", xlab = "PM10 (µg/m³)")
```

Lo que más llama la atención es que esta muy sesgado hacia la derecha:

La gran mayoría de los valores se agrupan en el rango bajo, mientras que hay una “cola” alargada que llega hasta valores muy altos. Esto indica que, aunque normalmente las concentraciones son bajas, existen episodios puntuales con picos muy elevados.

Esto podría deberse a la presencia de datos atípicos o outliers, que son valores que se desvían significativamente de la tendencia general de los datos. Para confirmar esto, vamos a calcular algunos estadísticos descriptivos.

```{r}
summary(df$PM10)
```

Podemos observar que el valor máximo de la variable es 1675, lo cual es muchísimo más alto de lo normal. Vamos a ver de donde provienen esos valores tan elevados. Para ello, vamos a ver la distribución del contaminante a lo largo del tiempo.

```{r}
df$FechaHora <- as.POSIXct(df$FechaHora, format = "%Y-%m-%d %H:%M:%S")

ggplot(df, aes(x = FechaHora, y = PM10, group = 1)) +
  geom_line(color = "steelblue") +
  scale_x_datetime(
    date_breaks = "1 year",    # un tick por año
    date_labels = "%Y"         # etiqueta con solo el año
  ) +
  labs(
    title = "Evolución temporal de PM10",
    x     = "Año",
    y     = expression(PM[10]~"(µg/m"^3*")")
  ) +
  theme_minimal()
```

En la gráfica de enicma podemos observar que los valores se disparan a finales de 2024, vamos a ver las fechas exactas. Esto lo vamos a hacer mostrando la fecha en la que el valor de PM10 supera los 500 por primera vez, que solo se superan a finales de 2024.

```{r}
min(df$FechaHora[df$PM10 > 500], na.rm = TRUE)
```

Esta es la fecha en la que se supera por primera vez el valor de 500 (según la OMS es muy peligroso para la salud), y vemos que es el 17 de noviembre de 2024. La DANA en Valencia empezó el 29 de octubre de 2024, por lo que tiene sentido que el pico se produzca en Noviembre y Diciembre. 

Además, dado que PM10 son partículas suspendidas en el aire, es normal que en episodios de lluvias intensas se produzcan picos de contaminación.

Para estudiar la distribución de la variable vamos a aislar los valores de la época de la DANA, ya que es un episodio excepcional. Nos interesa hacer esto para ver la distribución de la variable en condiciones más normales.

```{r}
df_sin_DANA <- subset(df, FechaHora < as.POSIXct("2024-11-17 18:00:00"))

ggplot(df_sin_DANA, aes(x = PM10)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de PM10",
    x     = expression(PM[10]~"(µg/"*m^3*")"),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Ahora, se muestra una distribución un poco más normal, aunque sigue habiendo una asimétria a la derecha. Esto es normal, ya que los contaminantes suelen tener más o menos los mismos valores excepto momentos puntuales en los que se disparan.

Vamos a aplicar una transformación logarítmica a la variable para ver si conseguimos una distribución más normal. Esto es algo que se suele hacer en estadística cuando tenemos datos sesgados.

```{r}
df_sin_DANA$log_PM10 <- log(df_sin_DANA$PM10 + 1)  # Se suma 1 para evitar log(0)
ggplot(df_sin_DANA, aes(x = log_PM10)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(PM10)",
    x     = expression(log(PM[10]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Al aplicar la transformación logarítmica a la variable, la distribución se vuelve más simétrica y menos sesgada. Esto es un indicativo de que la transformación ha funcionado y que los datos son más normales.

Ahora vamos a estudiar la distribución en la época de la DANA, para ver si hay diferencias significativas entre la época de la DANA y la época normal. 

```{r}
df_DANA <- subset(df, FechaHora > as.POSIXct("2024-11-17 18:00:00"))
ggplot(df_DANA, aes(x = PM10)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de PM10 en la DANA",
    x     = expression(PM[10]~"(µg/"*m^3*")"),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Vemos que la distribución en la época de la DANA es parecida a la distribución de la variable en condiciones normales, es decir, parece ser que la variable se comporta igual solo que con valores más altos debidos a la DANA.

Vamos a aplicar la transformación logarítmica a la variable para ver si conseguimos una distribución más normal.

```{r}
df_DANA$log_PM10 <- log(df_DANA$PM10 + 1) 
ggplot(df_DANA, aes(x = log_PM10)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(PM10) en la DANA",
    x     = expression(log(PM[10]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Al igual que antes, al aplicar la transformación logarítmica a la variable, la distribución se vuelve más simétrica y menos sesgada. Esto es un indicativo de que la transformación ha funcionado y que los datos son más normales.

Ahora vamos a ver la distribucion de todos los datos (DANA + no_DANA), aplicando la transformación logarítmica.

```{r}
df$log_PM10 <- log(df$PM10 + 1)
ggplot(df, aes(x = log_PM10)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(PM10)",
    x     = expression(log(PM[10]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```
Vemos que la distribución de PM10 al aplicar la transformación logarítmica es bastante normal (con un poco de sesgo a la derecha) incluyendo la DANA, excluyendo la DANA o incluso solo durante la DANA. Esto nos indica que el contaminante se comporta más o menos simpre igual, aunque en la DANA los valores son más altos.


#### Comportamiento por zonas

Vamos a ver la distribución del contaminante por zonas

```{r}
df %>%
  filter(!is.na(PM10)) %>%
  ggplot(aes(x = PM10)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de PM10 por estación",
      x     = "PM10 (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Vemos que en la mayoría de las estaciones la distribución de los calores es muy similar. Resalta un poco más el hecho de que hay algunas con unas colas un poco más alargadas, estas estaciones son las afectadas por la DANA. Lo cual tiene sentido que sus colas sean más largas ya que hubo una temporada con valores extremadamente altos. Vamos a ver la distribucion logaritmica.

```{r}
df %>%
  filter(!is.na(log_PM10)) %>%
  ggplot(aes(x = log_PM10)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de log(PM10) por estación",
      x     = "log(PM10) (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

En estas distribuciones, parece ser que si existen diferencias significativas en los valores de PM10 dependiendo de la zona de medicion. Esto lo veremos más adelante.

Vamos a ver gráficamente las medias de PM10 para cada estación para asi ver si varia mucho los valores.

```{r}
no_tomar <- c("València - Bulevard Sud",
              "Paterna - CEAM",
              "València - Nazaret Met-2",
              "València - Vivers",
              "València-Conselleria Meteo")

estaciones_pm10 <- setdiff(unique(df$Origen), no_tomar)

df_pm10 <- df %>%
  filter(Origen %in% estaciones_pm10)

# 2) Calcular la media de PM10 por estación (ignorando los NA)
media_por_estacion <- df_pm10 %>%
  group_by(Origen) %>%
  summarise(
    media_PM10 = mean(PM10, na.rm = TRUE),
    n_obs      = sum(!is.na(PM10))
  ) %>%
  ungroup() %>%
  arrange(desc(media_PM10)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

# 3) Gráfico de barras
ggplot(media_por_estacion, aes(x = Origen, y = media_PM10)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(media_PM10, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Media de PM10 por estación",
    subtitle = "Solo estaciones que miden PM10",
    x        = "Estación",
    y        = expression(Media~PM[10]~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(media_por_estacion$Origen, "=", media_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos valores promedio muy altos en las primeras 4 estaciones: 

- Massanassa_UM
- Benetusser UM
- Catarroja UM
- Paiporta UM

Estas estaciones son las más afectadas por la dana, y además ya vimos que solo tienen valores en 2024. Por lo que sus medias alteran el resultado ya que son casos excepcionales. Vamos a hacer lo mismo pero omitiendo la DANA.

```{r}
estaciones_DANA <- c("Massanassa_UM", "Benetusser UM", "Catarroja UM", "Paiporta UM", "Sedavi UM")

estaciones_pm10_sin_DANA <- setdiff(estaciones_pm10, estaciones_DANA)

df_pm10 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

# 2) Calcular la media de PM10 por estación (ignorando los NA)
media_por_estacion <- df_pm10 %>%
  group_by(Origen) %>%
  summarise(
    media_PM10 = mean(PM10, na.rm = TRUE),
    n_obs      = sum(!is.na(PM10))
  ) %>%
  ungroup() %>%
  arrange(desc(media_PM10)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

# 3) Gráfico de barras
ggplot(media_por_estacion, aes(x = Origen, y = media_PM10)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(media_PM10, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Media de PM10 por estación sin la DANA",
    subtitle = "Solo estaciones que miden PM10",
    x        = "Estación",
    y        = expression(Media~PM[10]~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(media_por_estacion$Origen, "=", media_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos que si que varía la media de PM10 dependiendo de su estación de medición, siendo en Valencia Olivereta el más alto. Vamos a hacer lo mismo pero para la mediana.

```{r}
df_pm10 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

# 2) Calcular la mediana de PM10 por estación (ignorando los NA)
mediana_por_estacion <- df_pm10 %>%
  group_by(Origen) %>%
  summarise(
    mediana_PM10 = median(PM10, na.rm = TRUE),
    n_obs      = sum(!is.na(PM10))
  ) %>%
  ungroup() %>%
  arrange(desc(mediana_PM10)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

# 3) Gráfico de barras
ggplot(mediana_por_estacion, aes(x = Origen, y = mediana_PM10)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(mediana_PM10, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Mediana de PM10 por estación sin la DANA",
    subtitle = "Solo estaciones que miden PM10",
    x        = "Estación",
    y        = expression(Mediana~PM[10]~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(mediana_por_estacion$Origen, "=", mediana_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Ahora observamos casi lo mismo que con la media, solo que algunas estaciones como València Port llit antic Túria supera a Quart de Poblet, cuando con la media no pasaba. 

Ahora vamos a realizar lo mismo pero para la desviación típica.

```{r}
df_pm10 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

sd_por_estacion <- df_pm10 %>%
  group_by(Origen) %>%
  summarise(
    sd_PM10 = sd(PM10, na.rm = TRUE),
    n_obs      = sum(!is.na(PM10))
  ) %>%
  ungroup() %>%
  arrange(desc(sd_PM10)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(sd_por_estacion, aes(x = Origen, y = sd_PM10)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(sd_PM10, 2)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Desviación típica de PM10 por estación",
    subtitle = "Solo estaciones que miden PM10",
    x        = "Estación",
    y        = expression(SD~PM10~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(sd_por_estacion$Origen, "=", sd_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Podemos observar que Quart de Poblet es la estación con la mayor desviación típica, lo cual indica que allí fluctuan mucho de una hra a otra. Estas fluctuaciones, pueden deberse a varios factores como por ejemplo el tráfico y la temperatura. Luego observamos que por ejemplo, València Politècnic tiene la menor desviación estandar por lo que sus valores tienden a ser más estacionarios.

Ahora vamos a ver los maximos y minimos medidos en cada estación.

```{r}
df_pm10 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

# 2) Calcular el valor mínimo y máximo de PM10 por estación
resumen_pm10 <- df_pm10 %>%
  group_by(Origen) %>%
  summarise(
    min_PM10 = min(PM10, na.rm = TRUE),
    max_PM10 = max(PM10, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(Origen)

print(resumen_pm10)

ggplot(resumen_pm10, aes(x = Origen)) +
  geom_linerange(aes(ymin = min_PM10, ymax = max_PM10), size = 1.5) +
  geom_point(aes(y = min_PM10), shape = 21, fill = "white", size = 3) +
  geom_point(aes(y = max_PM10), shape = 21, fill = "black", size = 3) +
  coord_flip() +
  labs(
    title = "Rango de valores de PM10 por estación",
    x     = "Estación",
    y     = expression(PM[10]~"(µg/m³)")
  ) +
  theme_minimal(base_size = 12)

```

Con el gráfico y la tabla de arriba podemos observar el rango de valores de cada estación. Podemos ver que Quart de Poblet y València Olivereta tienen rangos más altos, mientras que en València Politècnic los valores de PM10 varían menos. Esto ayuda a comprender los gráficos anterirores ya que lso que tiene los rangos más grandes son los que tienen medias y medianas más altas.

Ahora, vamos a estudiar si hay diferencias significativas en los valores de PM10 dependiendo de la estación de medición. Para ello, podríamos aplicar un ANOVA, pero dado que son series temporales, vamos a coger una muestra de 200 valores para mejorar las hipotesis del ANOVA.

```{r}
set.seed(123) # Para reproducibilidad
df_pm10 = df_sin_DANA%>%
  filter(FechaHora >= "2023-01-01" & FechaHora < "2024-01-01") %>%
  filter(hour(FechaHora) == 12) %>%
  filter(wday(FechaHora) == 2) %>%
  sample_n(200)
df_pm10$log_PM10 = log(df_pm10$PM10)

fit <- aov(PM10 ~ Origen, data = df_pm10)
summary(fit)
```

El valor de F y el p-value indican que podemos rechazar, con confianza, la hipotesis nula. Es decir, hay diferencias significativas entre las medias de los grupos, en este caso las estaciones de medición.

Antes de ver a que niveles existen diferenias significativas o no, vamos a comprobar las hipotesis del ANOVA. Primero vamos a comprobar la independencia de los residuos, lo haremos con el test de Durbin-Watson.

```{r}
dw <- dwtest(fit)
print(dw)
```

El hecho de que el valor DW sea mayor que 2, indica ausencia de autocorrelación de primer grado. Además, el p-value es mucho mayor que 0.05, por lo que no hay información suficiente para rechazar la hipotesis nula de no haber autocorrelación positiva. Debido a eso se cumple la condición de independencia.

Ahora vamos a comprobar la homogeniedad.

```{r}
leveneTest(fit)
```

Como el p-value es mayor que alpha, no podemos rechazar la igualdad de varianzas y por ello cumple la condición de homogeniedad del ANOVA.

Vamos a visualizar unos gráficos que demuestren lo indicado.

```{r}
par(mfrow = c(1, 1))
plot(fit)
```

Aparte de confirmar lo anterior, en el QQ-plot podemos comprobar la normalidad ya que los puntos siguen la recta bastante consitentemente. Además, el gráfico de Cook's distance confirma que no hay valores influyentes.

Ahora vamos a ver donde están esas diferencias. Para ello, vamos a aplicar un test de Tukey, el cual nos dará las diferencias significativas entre los  diferentes pares de estaciones.

```{r}
tukey_pm10 <- TukeyHSD(fit)

res <- as.data.frame(tukey_pm10$Origen)

res_ns <- subset(res, `p adj` <= 0.05)

print(res_ns)
```

En la tabla solo se muestran las combinaciones que presentan diferencias significativas entre ellas (p-value <= 0.05).

Esto es sorprendente, ya que estas zonas no son las que tienen valores más altos ni más bajos, de hecho, en la graficas de media y mediana tienen valores similares.

Esto indica que en estas zonas los valores de PM10 se ven afectados por su ubicación, esto podría deberse a muchos factores. Por ejemplo, a la densidad de tráfico en esas zonas, ya que unas estan más en el centro de la ciudad que otras. O tambien podría deberse a la meteorología, ya que puede variar. Todo esto lo estudiaremos más adelante. 

En resumen, los valores de PM10 no se ven afectados por la zona en la gran mayoría de casos. Por lo que la estación de medición no parece ser muy influyente.

#### Comportamiento por timepo

Vamos a ver como se comporta el contaminante a lo largo del tiempo. Para ello, vamos a hacer un gráfico con la evolución de la variable a lo largo del tiempo.

```{r}
df_sin_DANA$FechaHora <- as.POSIXct(df_sin_DANA$FechaHora, format = "%Y-%m-%d %H:%M:%S")

ggplot(df_sin_DANA, aes(x = FechaHora, y = PM10, group = 1)) +
  geom_line(color = "steelblue") +
  scale_x_datetime(
    date_breaks = "1 year",    
    date_labels = "%Y"        
  ) +
  labs(
    title = "Evolución temporal de PM10",
    x     = "Año",
    y     = expression(PM[10]~"(µg/m"^3*")")
  ) +
  theme_minimal()
```

En el gráfico, parece haber un ligero comportamiento estacional, es decir, parece que hay subidas y bajadas en los valores de PM10 a lo largo del tiempo. Además, se puede observar que a finales de 2023 y todo 2024 los picos son, en general, más altos.

Ahora vamos a ver un gráfico con la media de PM10 en cada año.

```{r}
# Cálculo de la media por año
df_anual <- df_sin_DANA %>%
  group_by(Año) %>%
  summarise(media_PM10 = mean(PM10, na.rm = TRUE)) %>%
    mutate(Año = as.numeric(as.character(Año))) %>%
  arrange(Año)

# Gráfico con área sombreada y línea en rojo
ggplot(df_anual, aes(x = Año, y = media_PM10)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)) +
  labs(
    title    = "Yearly evolution of the average PM10 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Year",
    y        = "Average of PM10 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  # Tema minimalista con toques de color
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Se puede observar que en 2020 hubo una disminución considerable en los niveles de PM10, probabemente debido a la pandemia de COVID-19 y lsa restricciones que hubo (trafico,..). Luego, los niveles vuelven a aumentar, pero no tanto como en 2019.

Tambien observamos que a partir de 2022, la concentración media comienza a disminuir, lo  cual puede deberse a que la UE esta intentando reducir las emisiones de CO2. Las emisiones de CO2 estan relacionadas con PM10 ya que crea un efecto invernadero y no deja que el contaminante se disperse correctamente en la atmosfera.

```{r}
df_anual_sd <- df_sin_DANA %>%
  group_by(Año) %>%
  summarise(sd_PM10 = sd(PM10, na.rm = TRUE)) %>%
    mutate(Año = as.numeric(as.character(Año))) %>%
  arrange(Año)

# Gráfico con área sombreada y línea en rojo
ggplot(df_anual_sd, aes(x = Año, y = sd_PM10)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)) +
  labs(
    title    = "Yearly evolution of the standard deviation of PM10 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Year",
    y        = "SD of PM10 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  # Tema minimalista con toques de color
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos que la desviación típica de PM10 va disminuyendo a partir de 2019 hasta 2021, lo cual significa que habian menos picos de contaminación, probablemente debido a la pandemia. Durante la pandemia no había mucho tráfico por lo que se redujo la contaminación. Y a partir de 2021 la variabilidad del contaminante vuelve a incrementar debido a la vuelta a la normalidad.

Vemos, que sigue la misma estructura que la media, lo cual tiene sentido e indica que la variable PM10 tiene una desviación tipica más o menos constante en terminos de proporciones. Ya que cuando la media de PM10 sube, tambien lo hace la desviacion estandar y lo mismo cuando baja.

Podemos concluir que los valores de PM10 si dependen de el año. Pero a la vez, su varibilidad es proporcionalmente parecida en todos los años.

#### Comportamiento por meses

```{r}
meses_orden <- c("Enero","Febrero","Marzo","Abril","Mayo","Junio",
                 "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre")

df_mensual <- df_sin_DANA %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(media_PM10 = mean(PM10, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual, aes(x = mes_num, y = media_PM10)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual del promedio de PM10",
    subtitle = "Promedio mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "Concentración promedio de PM10 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

En el gráfico, se puede observar que los niveles de PM10 son más altos en los primeros 3 meses del año. Los siguientes meses disminuyen considerablemente, pero en verano vuelven a aumentar un poco y luego vuelven a bajar. No parece haber un patrón claro en los meses, pero al realizar un ANOVA, podemos esperar que los meses causan diferencias significativas en los niveles de PM10. Vamos a comprobarlo.

Ahora vamos a ver como son las desviaciones típicas de PM2.5 para cada mes.

```{r}
df_mensual_sd <- df_sin_DANA %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(sd_PM10 = sd(PM10, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual_sd, aes(x = mes_num, y = sd_PM10)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la desviacion típica de PM10",
    subtitle = "Desviaciones típicas mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "Desviación típica de PM10 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Vemos que la desviación típica varia a la par con la media, es decir cuando una sube la otra también lo hace. Esto nos indica que las desviación típica es bastante constante.

Podemos concluir que las mediciones de PM10 se ven afectadas por el mes en el que se miden, sobre todo en los meses más frios en Valencia.

#### Comportamiento por dia de la semana

```{r}
# 1. Definir el orden correcto de los días
dias_orden <- c("lunes","martes","miércoles","jueves","viernes","sábado","domingo")

df_semanal <- df_sin_DANA %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(media_PM10 = mean(PM10, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal, aes(x = dia_num, y = media_PM10)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la concentración promedio de PM10",
    subtitle = "Promedios semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "Promedio de PM10 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

En esta ocasión, podemos observar que los niveles de PM10 son más o menos iguales durante la semana excepto los fines de semana, donde los valores parecen disminuir considerablemente. Esto puede deberse a que durante el fin de semana hay menos tráfico y menos actividad industrial, lo que provoca una disminución en los niveles de contaminación.

Vamos a hacer lo mismo para la desviación típica de la variable.

```{r}
df_semanal_sd <- df_sin_DANA %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(sd_PM10 = sd(PM10, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_sd, aes(x = dia_num, y = sd_PM10)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la desviación típica de PM10",
    subtitle = "Desviaciones típicas semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "DS de PM10 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Al igual que en los otros casos, la desviación típica se comporta igual que la media. Pero cabe destacar que el lunes y martes tienen una desviación típica proporcional más baja. Lo que significa que las mediciones en esos días son más constantes.

Por lo que deducimos que los valores de PM10 si se ven afectados por el dia de la semana, probablemente debido al tráfico.

#### Comportamiento por horas

```{r}

df_hourly <- df_sin_DANA %>%
  group_by(Hora) %>%
  summarise(media_PM10 = mean(PM10, na.rm = TRUE)) %>%
  mutate(Hora = as.numeric(as.character(Hora))) %>%
  arrange(Hora)

ggplot(df_hourly, aes(x = Hora, y = media_PM10)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(breaks = 0:23, limits = c(0, 23)) +
  labs(
    title    = "Hourly evolution of the average PM10 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "Average of PM10 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )

```

En este caso, podemos observar mucha variación en los niveles de PM10 a lo largo del día. Los niveles son bajos por la madrugada, a partir de las 6 sufren un aumento muy notable, alcanzando su máximo a las 8 de la mañana. Luego, a medida que pasa el dia va disminuyendo, hasta las 17 horas, que vuelve a incrementar. Esto podría deberse a la temperatura o el tráfico, lo cual comprobaremos más adelante.

Vamos a hacer lo mismo para la desviación típica.

```{r}
df_hourly_sd <- df_sin_DANA %>%
  group_by(Hora) %>%
  summarise(sd_PM10 = sd(PM10, na.rm = TRUE)) %>%
  mutate(Hora = as.numeric(as.character(Hora))) %>%
  arrange(Hora)

ggplot(df_hourly_sd, aes(x = Hora, y = sd_PM10)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(breaks = 0:23, limits = c(0, 23)) +
  labs(
    title    = "Hourly evolution of the strandard deviation of PM10",
    subtitle = "Standard deviation values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "SD of PM10 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )

```

Como era de esperar, las desviaciones típicas varían junto a la media. Pero a las 11 y 12 las desviaciones típicas proporcionales parecen ser menores. Lo que se puede deber a más constancia en los valores.

Podemos confirmar que la hora del dia influencia bastante en los valores de PM10, probablemente debido al tráfico rodado.

#### Faltantes

Primero de todo, vamos a ver el porcentaje de faltantes que tenemos en la variable PM10.

```{r}
sum(is.na(df$PM10)) / nrow(df) * 100
```

Tenemos un 40% de faltantes, vamos a ver en que estaciones tenemos más faltantes.

```{r}
df %>%
  filter(is.na(PM10)) %>%
  count(Origen) %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = reorder(Origen, -n), y = n)) +
  geom_bar(stat = "identity", fill = "firebrick") +
  labs(title = "Número de valores faltantes (NA) en PM10 por estación",
       x = "Estación (Origen)",
       y = "Número de NAs") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Resalta que hay varias estaciones con un número elevado de faltantes, lo cual se puede deber a que no se mide PM10 en esas estaciones. 

```{r}
resumen_PM10 <- df %>%
  select(Origen, PM10) %>%
  pivot_longer(
    cols      = -Origen,
    names_to  = "Variable",
    values_to = "Valor"
  ) %>%
  filter(Variable == "PM10", !is.na(Valor)) %>%
  group_by(Variable) %>%
  summarise(
    num_estaciones    = n_distinct(Origen),
    lista_estaciones  = paste(sort(unique(Origen)), collapse = ", ")
  ) %>%
  ungroup()

print(resumen_PM10)
```

La variable PM10 se mide en 15 estaciones, las estaciones que no la miden son:

- València - Bulevard Sud
- Paterna - CEAM
- València - Nazaret Met-2
- València - Vivers
- València-Conselleria Meteo

Que son las que más faltantes tienen. Ahora vamos a descartar estas estaciones.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_pm10) %>%
  group_by(Origen) %>%
  summarise(
    n     = sum(is.na(PM10)),
    total = n(),                  # total de filas por estación
    pct   = n / total * 100       # porcentaje de NAs
  ) %>%
  arrange(desc(n))

# 2) Gráfico con porcentaje como etiqueta
ggplot(df_plot, aes(x = reorder(Origen, -n), y = n)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Número y % de valores faltantes (NA) en PM10 por estación",
    x     = "Estación (Origen)",
    y     = "Número de NAs"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

En el nuevo gráfico, podemos observar que la mayoría de los faltantes se encuentran en Torrent, donde hay un 43% de faltantes. Esos porcentajes indican la proporción de faltantes en esa estacion.

Ahora vamos a ver cuanto faltantes tenemos en total, es decir, en todas las estaciones.

```{r}
resumen_total <- df %>%
  filter(Origen %in% estaciones_pm10) %>%
  summarise(
    total_obs     = n(),
    faltantes     = sum(is.na(PM10)),
    pct_faltantes = faltantes / total_obs * 100
  )

print(resumen_total)
```

Al haber eliminado las estaciones que no miden PM10, nos quedamos con un poco menos de 5% de faltantes. Antes de imputarlos, vamos a ver si hay algún patrón en los faltantes. 

Por años:

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_pm10,  # opcional: solo ciertas estaciones
    is.na(PM10)                   # quedarnos solo con los NAs
  ) %>%
  count(Año, name = "n_missing") %>%  # contar NAs por cada valor de Año
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),            # total de NAs en todos los años
    pct_total     = n_missing / total_missing * 100  # % sobre el total de NAs
  ) %>%
  arrange(Año)

# 2) Gráfico de barras con porcentaje de faltantes por año
ggplot(df_plot, aes(x = factor(Año), y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de PM10 por año",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese año",
    x        = "Año",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x    = element_text(face = "bold"),
    plot.title     = element_text(face = "bold", hjust = 0.5),
    plot.subtitle  = element_text(hjust = 0.5)
  )
```

 La mayoría de los faltantes se concentran en 2023. Ahora vamos a hacer lo mismo pero por meses.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_pm10) %>%              # opcional: filtrar solo estaciones_pm10
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  filter(is.na(PM10)) %>%                              # quedarnos solo con los NAs
  count(Mes, name = "n_missing") %>%                   # contar NAs por mes
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),                    # total de NAs
    pct_total     = n_missing / total_missing * 100    # % de cada mes sobre el total
  )

# 2) Gráfico
ggplot(df_plot, aes(x = Mes, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Porcentaje de valores faltantes de PM10 por mes",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese mes",
    x = "Mes",
    y = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```

En este gráfico, observamos que la mayoría de los faltantes se encuentran en Septiembre. Ahora lo mismo para días de la semana.

```{r}
df_plot <- df %>%
  filter(
    Origen   %in% estaciones_pm10,   # solo estas estaciones (si aplica)
    is.na(PM10)                      # quedarnos sólo con los NA
  ) %>%
  count(Dia_Semana, name = "n_missing") %>%  # contar NAs por día
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),          # total de NAs
    pct_total     = n_missing / total_missing * 100  # % sobre el total
  ) %>%
  # aseguramos el orden correcto de los días
  mutate(Dia_Semana = factor(Dia_Semana, levels = dias_orden)) %>%
  arrange(Dia_Semana)

# 2) Gráfico
ggplot(df_plot, aes(x = Dia_Semana, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de PM10 por día de la semana",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese día",
    x        = "Día de la semana",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

Parece ser, que los faltantes se distribuyen uniformemente entre los días de la semana. Ahora vamos a ver por horas del dia.

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_pm10,   # filtrar solo las estaciones de interés
    is.na(PM10)                    # quedarnos solo con los NAs
  ) %>%
  count(Hora, name = "n_missing") %>%  # contar NAs por hora
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),           # total de NAs
    pct_total     = n_missing / total_missing * 100  # % sobre el total
  ) %>%
  arrange(Hora)

# 2) Gráfico de barras con porcentaje de faltantes por hora
ggplot(df_plot, aes(x = Hora, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  scale_x_continuous(breaks = 0:23) +
  labs(
    title    = "Porcentaje de valores faltantes de PM10 por hora del día",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en esa hora",
    x        = "Hora",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(face = "bold"),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

Sucede los mismo que con los días de la semana, los faltantes se distribuyen uniformemente entre las horas del día. 

Por lo que podemos conluir que parece haber un patron entre los año y meses, ya que ahi se ven diferencias significativas. En el resto de variables, no parece haber un patrón claro.

Para si hay un patrón vamos a ver si un faltante se repite en otros años. Esto lo vamos a hacer siguiendo estos pasos:

-filtrar estaciones que miden la variable
- Seleccionar filas donde la variable es NA
- Agrupar por combinación de Mes, Dia y Hora
- Calcular el numero de años distintos con al menos ese NA y contruimos la lista de años
- Solo nos quedamos con los que se repiten en más de un año

```{r}
df_faltantes_pm10 <- df %>%
  filter(Origen %in% estaciones_pm10)

faltantes_recurrentes <- df_faltantes_pm10 %>%
  filter(is.na(PM10)) %>%
  group_by(Mes, Dia, Hora) %>%
  summarise(
    n_años               = n_distinct(Año),
    Años_con_faltante    = paste(sort(unique(Año)), collapse = ", "),
    .groups              = "drop"
  ) %>%
  filter(n_años > 1) %>%        
  select(Mes, Dia, Hora, Años_con_faltante)

print(faltantes_recurrentes)
```

Podemos observar que si parece haber un patrón en los faltantes, ya que hay muchas fechas con el mismo faltante pero en otros años.

```{r}
df %>%
  mutate(missing = is.na(PM10)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c('TRUE' = "red", 'FALSE' = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de PM10",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()
```

Gracias al gráfico, podemos ver facilmente la distribucion de los faltantes, y es mas sencillo encontrar patrones.

## PM2.5

Ahora vamos a hacer lo mismo pero para el contaminante PM2.5. Esperamos que los resultados sean similares a los de PM10, ya que son contaminantes similares y tienen fuentes de emisión similares.

Primero de todo, vamos a ver su distribución.

```{r}
hist(df$PM2.5, breaks = 30, col = "skyblue", main = "Histograma de PM2.5", xlab = "PM2.5 (µg/m³)")
```

Como esperábamos, tiene una distribución parecida a la de PM10, solo que menos sesgada a la derecha. Al igual que con PM10, vamos a ver algunos estadisticos descriptivos.

```{r}
summary(df$PM2.5)
```

Como podemos ver, el valor máximo es 309, el cual esta dentro del rango 'peligroso' según la OMS y EPA. En el caso de PM10, los valores tan sumamente altos eran debidos a la DANA, vamos a ver si aquí sucede lo mismo.

```{r}
ggplot(df, aes(x = FechaHora, y = PM2.5, group = 1)) +
  geom_line(color = "steelblue") +
  scale_x_datetime(
    date_breaks = "1 year",    
    date_labels = "%Y"        
  ) +
  labs(
    title = "Evolución temporal de PM2.5",
    x     = "Año",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal()
```

Podemos observar, que si que hay valores altos a finales de 2024, la fecha de la DANA. Pero a la vez, observamos que hay picos altos en otras fechas, como en 2020 y 2022. Según la OMS, a partir de 125 µg/m3 es insalubre,y a partir de 200 µg/m3 peligroso, por lo que antes de seguir adelante, vamos a analizar estos picos peligrosos.

Primero vamos a ver las fechas de los picos altos, es decir los valores superiores a 200 µg/m3 (excluyendo la DANA).

```{r}
fechas_valores_exceso <- df_sin_DANA %>%
  filter(`PM2.5` > 200) %>%
  select(Fecha, Hora, Origen, `PM2.5`) %>%      
  arrange(Fecha)

print(fechas_valores_exceso)
```

Se muestran las fechas, horas y origen de los valores superiores a 200. Lo que más resalta es que para el 2022-08-18 a la 1 de la mañana, hubieron valores altos en 5 estaciones. Lo cual nos hace pensar que sucedió algo.

Ahora vamos a investigar mas a fondo las fechas, para ver si los valores de esos dias son reales o erroneos.

Primero, estación `València Port Moll Trans. Ponent` y fecha `2020-10-02`.

```{r}
valores_origen <- df_sin_DANA %>%
  filter(
    Fecha  == as.Date("2020-10-02"),
    Origen == "València Port Moll Trans. Ponent"
  ) %>%
  # Convertimos a factor para eje discreto
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `PM2.5`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `PM2.5`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  # Eje discreto para factores
  scale_x_discrete() +
  labs(
    title = "PM2.5 por hora el 2020-10-02 (Origen: València Port Moll Trans. Ponent)",
    x     = "Hora",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

En este caso, parece ser algo justificado ya que incrementa un poco cada hora hasta llegar al maximo, por lo que no parece deberse a un error. Podría deberse a que por ejemplo, duarnate esas hora hubo un mayor trafico de barcos en el puerto.

Segundo, estación `València - Centre` y fecha `2022-08-18`.

```{r}
valores_origen <- df_sin_DANA %>%
  filter(
    Fecha  == as.Date("2022-08-18"),
    Origen == "València - Centre"
  ) %>%
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `PM2.5`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `PM2.5`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  scale_x_discrete() +
  labs(
    title = "PM2.5 por hora el 2022-08-18 (Origen: València - Centre)",
    x     = "Hora",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

En este caso, se observa un valor extremadamente alto a la 1 de la madrugada y luego el resto del dia se observan valores normales. Esto parece ser un error.

Tercero, estación `València Olivereta` y fecha `2022-08-18`

```{r}
valores_origen <- df_sin_DANA %>%
  filter(
    Fecha  == as.Date("2022-08-18"),
    Origen == "València Olivereta"
  ) %>%
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `PM2.5`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `PM2.5`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  scale_x_discrete() +
  labs(
    title = "PM2.5 por hora el 2022-08-18 (Origen: València Olivereta)",
    x     = "Hora",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

En este caso volvemos a observar lo mismo que antes, lo cual parece un error tambien, pero al ser la misma fecha y misma hora podría no deberse a un error. 

Cuarto, estacion `València - Pista de Silla` y fecha `2022-08-18`.

```{r}
valores_origen <- df_sin_DANA %>%
  filter(
    Fecha  == as.Date("2022-08-18"),
    Origen == "València - Pista de Silla"
  ) %>%
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `PM2.5`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `PM2.5`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  scale_x_discrete() +
  labs(
    title = "PM2.5 por hora el 2022-08-18 (Origen: València - Pista de Silla)",
    x     = "Hora",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Otra vez, observamos lo mismo que antes, lo cual es raro. 

Quinto, esatcion `València Port Moll Trans. Ponent` y fecha `2022-08-18`.

```{r}
valores_origen <- df_sin_DANA %>%
  filter(
    Fecha  == as.Date("2022-08-18"),
    Origen == "València Port Moll Trans. Ponent"
  ) %>%
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `PM2.5`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `PM2.5`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  scale_x_discrete() +
  labs(
    title = "PM2.5 por hora el 2022-08-18 (Origen: València Port Moll Trans. Ponent)",
    x     = "Hora",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Volvemos a observar el mismo comportamiento de antes. Vamos a ver si la otra estacion tambien.

Sexta, estacion `València Port llit antic Túria` y fecha `2022-08-18`.

```{r}
valores_origen <- df_sin_DANA %>%
  filter(
    Fecha  == as.Date("2022-08-18"),
    Origen == "València Port llit antic Túria"
  ) %>%
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `PM2.5`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `PM2.5`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  scale_x_discrete() +
  labs(
    title = "PM2.5 por hora el 2022-08-18 (Origen: València Port llit antic Túria)",
    x     = "Hora",
    y     = expression(PM[2.5]~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Y como esperábamos, todas las estaciones con valores altos el 18 de Agosto del 2022, se comportan igual. Con un valor altísimo a la 1 de la madrugada y luego valores normales. 

Esto resulta muy raro ya que no tiene sentido un cambio tan drástico en los valores de PM10, por lo que podría deberse de un error. De todas formas, el hecho de que varias estaciones sufran lo mismo, hace pensar que pueda haber una razón detrás, ya sea algo real (meteorología, incendio,...) o fue un error general.

Vamos a ver si sucede lo mismo para la variable PM10:

```{r}
estaciones <- c(
  "València - Centre",
  "València Port llit antic Túria",
  "València - Pista de Silla",
  "València Port Moll Trans. Ponent",
  "València Olivereta"
)

# 4. Filtra para el 18 de agosto de 2022 y esas estaciones
df_sel <- df_sin_DANA %>%
  select(Origen, Fecha, Hora, PM10) %>%
  filter(
    Fecha    == as_date("2022-08-18"),
    Origen %in% estaciones,
    Hora == 1
  )

df_sel
```

Podemos observar que en esa fecha y esa hora, la variable PM10 tambien registro valores más altos de lo normal. Esto hace pensar que son valores reales. O tambien podría ser un error general en estas estaciones ya que un aumento tan extremo en tan solo 1 hora es muy raro.

Ya que saber la verdadera razón de esto es muy complicado, no las tocaremos y ya más adelante veremos si hay relación con meteorología, tráfico,...

Distribución:

Al igual que antes, vamos a ver la distribución de PM2.5 durante la época 'normal', es decir sin la DANA.

```{r}
ggplot(df_sin_DANA, aes(x = PM2.5)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de PM2.5",
    x     = expression(PM[2.5]~"(µg/"*m^3*")"),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Al excluir la DANA, la distribución parece haberse suavizado un poco, pero sigue estando sesgada a la derecha. Ahora vamos a aplicar una transformación logaritmica para ver si la distribución se normaliza un poco.

```{r}
df_sin_DANA$log_PM2.5 <- log(df_sin_DANA$PM2.5 + 1)

ggplot(df_sin_DANA, aes(x = log_PM2.5)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(PM2.5)",
    x     = expression(log(PM[2.5]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Pese a que ahora se asemeja más a una distribución normal, sigue teniendo cierta asimetría. Ahora vamos a ver el comportamiento de PM2.5 durante la DANA.

```{r}
ggplot(df_DANA, aes(x = PM2.5)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de PM2.5",
    x     = expression(PM[2.5]~"(µg/"*m^3*")"),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Durante la DANA, los valores de PM2.5 estan un poco menos sesgados a la derecha, vamos a aplicar la transformación logaritmica para ver si se normaliza un poco.

```{r}
df_DANA$log_PM2.5 <- log(df_DANA$PM2.5 + 1)

ggplot(df_DANA, aes(x = log_PM2.5)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(PM2.5)",
    x     = expression(log(PM[2.5]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Sucede algo similar que excluyendo la DANA, la distribución se asimila más a una normal, pero sigue teniendo cierta asimetría, ambos casos tienen problemas en la cola izquierda.

Ahora vamos a ver la distribución logaritmica de todo junto, es decir con la DANA.

```{r}
df$log_PM2.5 <- log(df$PM2.5 + 1)

ggplot(df, aes(x = log_PM2.5)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(PM2.5)",
    x     = expression(log(PM[2.5]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Otra vez, tenemos una distribución parecida a la normal, pero con problemas en la cola izquierda.

#### Comportamiento por zonas

Vamos a ver la distribución del contaminante por zonas.

```{r}
df %>%
  filter(!is.na(PM2.5)) %>%
  ggplot(aes(x = PM2.5)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de PM2.5 por estación",
      x     = "PM2.5 (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Sucede lo mismo que en la variable PM2.5, hay algunas zonas con colas mayores en las estaciones afectadas por la DANA. Vamos a ver la ditribucion logaritmica de PM2.5.

```{r}
df %>%
  filter(!is.na(log_PM2.5)) %>%
  ggplot(aes(x = log_PM2.5)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de log(PM2.5) por estación",
      x     = "log(PM2.5) (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Observamos que muchas zonas se siguen distribuyendo igual, con una concentración mayor en valores altos que bajos. Parece ser que en algunos casos la zona si que influye.

Vamos a ver gráficamente las medias de PM2.5 para cada estación para asi ver si varia mucho los valores.

```{r}
df_pm2.5 <- df %>%
  filter(Origen %in% estaciones_pm10)

# 2) Calcular la media de PM10 por estación (ignorando los NA)
media_por_estacion <- df_pm2.5 %>%
  group_by(Origen) %>%
  summarise(
    media_PM2.5 = mean(PM2.5, na.rm = TRUE),
    n_obs      = sum(!is.na(PM2.5))
  ) %>%
  ungroup() %>%
  arrange(desc(media_PM2.5)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

# 3) Gráfico de barras
ggplot(media_por_estacion, aes(x = Origen, y = media_PM2.5)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(media_PM2.5, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Media de PM2.5 por estación",
    subtitle = "Solo estaciones que miden PM2.5",
    x        = "Estación",
    y        = expression(Media~PM[2.5]~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(media_por_estacion$Origen, "=", media_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos, al igual que antes, valores promedio muy altos en las primeras 4 estaciones: 

- Massanassa_UM
- Benetusser UM
- Catarroja UM
- Paiporta UM

Estas estaciones son las más afectadas por la dana, y además ya vimos que solo tienen valores en 2024. Por lo que sus medias alteran el resultado ya que son casos excepcionales. Vamos a hacer lo mismo pero omitiendo la DANA.

```{r}
df_pm2.5 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

media_por_estacion <- df_pm2.5 %>%
  group_by(Origen) %>%
  summarise(
    media_PM2.5 = mean(PM2.5, na.rm = TRUE),
    n_obs      = sum(!is.na(PM2.5))
  ) %>%
  ungroup() %>%
  arrange(desc(media_PM2.5)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(media_por_estacion, aes(x = Origen, y = media_PM2.5)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(media_PM2.5, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Media de PM2.5 por estación sin la DANA",
    subtitle = "Solo estaciones que miden PM2.5",
    x        = "Estación",
    y        = expression(Media~PM[2.5]~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(media_por_estacion$Origen, "=", media_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

En este caso observamos algo similar a PM10 pero València Molí del Sol tiene la media más añta en PM2.5, mientras que en PM10 era la segunda más baja.

Vamos a ver que sucede con las medianas.

```{r}
df_pm2.5 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

mediana_por_estacion <- df_pm2.5 %>%
  group_by(Origen) %>%
  summarise(
    mediana_PM2.5 = median(PM2.5, na.rm = TRUE),
    n_obs      = sum(!is.na(PM2.5))
  ) %>%
  ungroup() %>%
  arrange(desc(mediana_PM2.5)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(mediana_por_estacion, aes(x = Origen, y = mediana_PM2.5)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(mediana_PM2.5, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Mediana de PM2.5 por estación sin la DANA",
    subtitle = "Solo estaciones que miden PM2.5",
    x        = "Estación",
    y        = expression(Media~PM[2.5]~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(mediana_por_estacion$Origen, "=", mediana_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos una estructura similar a la de PM10. Vemos que la mediana tiene más o menos la misma varianza que la media. 

Vamos a hacer lo mismo pero para la desviación típica.

```{r}
df_pm2.5 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

sd_por_estacion <- df_pm2.5 %>%
  group_by(Origen) %>%
  summarise(
    sd_PM2.5 = sd(PM2.5, na.rm = TRUE),
    n_obs      = sum(!is.na(PM2.5))
  ) %>%
  ungroup() %>%
  arrange(desc(sd_PM2.5)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(sd_por_estacion, aes(x = Origen, y = sd_PM2.5)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(sd_PM2.5, 2)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Desviación típica de PM2.5 por estación",
    subtitle = "Solo estaciones que miden PM2.5",
    x        = "Estación",
    y        = expression(SD~PM2.5~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(sd_por_estacion$Origen, "=", sd_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

La estación Molí del Sol, tiene una desviación típica algo maás significativa que el resto de estaciones, lo que indica que sus valores fluctuan más mientras que en las otras son más constantes.

Ahora vamos a ver los valores máximos y minimos de cada estación.

```{r}
df_pm2.5 <- df %>%
  filter(Origen %in% estaciones_pm10_sin_DANA)

resumen_pm2.5 <- df_pm2.5 %>%
  group_by(Origen) %>%
  summarise(
    min_PM2.5 = min(PM2.5, na.rm = TRUE),
    max_PM2.5 = max(PM2.5, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(Origen)

print(resumen_pm2.5)

ggplot(resumen_pm2.5, aes(x = Origen)) +
  geom_linerange(aes(ymin = min_PM2.5, ymax = max_PM2.5), size = 1.5) +
  geom_point(aes(y = min_PM2.5), shape = 21, fill = "white", size = 3) +
  geom_point(aes(y = max_PM2.5), shape = 21, fill = "black", size = 3) +
  coord_flip() +
  labs(
    title = "Rango de valores de PM2.5 por estación",
    x     = "Estación",
    y     = expression(PM[2.5]~"(µg/m³)")
  ) +
  theme_minimal(base_size = 12)
```

Hay muchas estaciones que tienen rangos similares para PM2.5 como para PM10, pero hay otros que sus rangos son mucho menores, como por ejemplo Quart de Poblet.

Ahora, vamos a estudiar si hay diferencias significativas en los valores de PM2.5 dependiendo de la estación de medición. Para ello, podríamos aplicar un ANOVA, pero dado que son series temporales, vamos a coger una muestra de 200 valores para mejorar las hipotesis del ANOVA.

```{r}
set.seed(123) # Para reproducibilidad
df_pm2.5 = df_sin_DANA%>%
  filter(FechaHora >= "2023-01-01" & FechaHora < "2024-01-01") %>%
  filter(hour(FechaHora) == 12) %>%
  filter(wday(FechaHora) == 2) %>%
  sample_n(200)
df_pm2.5$log_PM2.5 = log(df_pm2.5$PM2.5)

fit_pm2.5 <- aov(log_PM2.5 ~ Origen, data = df_pm2.5)
summary(fit_pm2.5)
```

El valor de F y el p-value indican que podemos rechazar, con confianza, la hipotesis nula. Es decir, hay diferencias significativas entre las medias de los grupos, en este caso las estaciones de medición.

Antes de ver a que niveles existen diferenias significativas o no, vamos a comprobar las hipotesis del ANOVA. Primero vamos a comprobar la independencia de los residuos, lo haremos con el test de Durbin-Watson.

```{r}
dw <- dwtest(fit_pm2.5)
print(dw)
```

El hecho de que el valor DW sea cercano a 2, indica ausencia de autocorrelación de primer grado. Además, el p-value es mucho mayor que 0.05, por lo que no hay información suficiente para rechazar la hipotesis nula de no haber autocorrelación positiva. Debido a eso se cumple la condición de independencia.

Ahora vamos a comprobar la homogeniedad.

```{r}
leveneTest(fit_pm2.5)
```

Como el p-value es menor que 0.05, rechazamos la hipotesis nula y por tanto no se cumple la condición de homogeniedad del ANOVA. Debido a eso vamos a hacer un ANOVA de Welch, ya que no asume varianzas iguales.

```{r}
oneway.test(log_PM2.5 ~ Origen, data = df_pm2.5, var.equal = FALSE)
```

La hipótesis nula es que todas las medias de log_PM2.5 son iguales independientemente del origen.
Como el p-value es menor que 0.05, rechazamos la hipotesis nula, y por tanto existe al menos un par de origenes cuyas medias difieren significativamente.

```{r}
tukey_pm10 <- TukeyHSD(fit_pm2.5)

res <- as.data.frame(tukey_pm2.5$Origen)

res_ns <- subset(res, `p adj` <= 0.05)

print(res_ns)
```

Esto muestra que tan solo 3 pares de estaciones tienen diferencias significativas entre ellas, todas tienen como factor comun la zona Quart de Poblet. Son las mismas que en PM10.

Con esto podemos concluir que, los valores de PM2.5 no varían dependiendo de la zona, excepto las estaciones que se vieron afectadas por la DANA en 2024.

#### Comportamiento por timepo

Vamos a ver como se comporta el contaminante cada año Para ello, vamos a hacer un gráfico.

```{r}
df_anual_pm2.5 <- df_sin_DANA %>%
  mutate(Año = as.integer(as.character(Año))) %>%
  group_by(Año) %>%
  summarise(media_PM2.5 = mean(PM2.5, na.rm = TRUE)) %>%
  arrange(Año)

ggplot(df_anual_pm2.5, aes(x = Año, y = media_PM2.5)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)
  ) +
  labs(
    title    = "Yearly evolution of the average PM2.5 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Year",
    y        = "Average of PM2.5 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos que de 2019 a 2020 hubo un decrecimiento, esto puede deberse a la pandemia y sus restricciones. Luego paarece que se ha mantenido más o menos constante. 

Tambien observamos que a partir de 2022, la concentración media comienza a disminuir, lo  cual puede deberse a que la UE esta intentando reducir las emisiones de CO2. Las emisiones de CO2 estan relacionadas con PM2.5 ya que crea un efecto invernadero y no deja que el contaminante se disperse correctamente en la atmosfera.

Vamos a hacer los mismo pero con las desviaciones típicas.

```{r}
df_anual_sd <- df_sin_DANA %>%
  group_by(Año) %>%
  summarise(sd_PM2.5 = sd(PM2.5, na.rm = TRUE)) %>%
    mutate(Año = as.numeric(as.character(Año))) %>%
  arrange(Año)

ggplot(df_anual_sd, aes(x = Año, y = sd_PM2.5)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)) +
  labs(
    title    = "Yearly evolution of the standard deviation of PM2.5 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Year",
    y        = "SD of PM2.5 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos que la desviación típica de PM2.5 va disminuyendo a partir de 2019 hasta 2024, debido a que la media tambien va disminuyendo al cabo de los años. Lo más llamativo es que las desviaciones tipicas proporcinalmente, son superiores en 2020 y 2021. Esto se puede deber a que durante la pandemia habia muy poco tráfico rodado y los pocos automoviles que circulaban aumentaban los valores considerablemente, generando asi una mayor desviacion típica.

Podemos concluir que los valores de PM2.5 si dependen de el año. Pero a la vez, su varibilidad es proporcionalmente parecida en todos los años.

#### Comportamiento por meses

```{r}
df_mensual <- df_sin_DANA %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(media_PM2.5 = mean(PM2.5, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual, aes(x = mes_num, y = media_PM2.5)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la concentración promedio de PM2.5",
    subtitle = "Promedios mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "Promedio de PM2.5 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos una gráfica muy similar a la generada con la variable PM10, lo cual tiene sentido ya que estos contaminantes son muy parecidos. En este caso, parece ser que en temperaturas extremas, es decir o mucho calor o mucho frío, los niveles aumentan, esto se estudiará más adelante.

Ahora vamos a ver como son las desviaciones típicas de PM2.5 para cada mes.

```{r}
df_mensual_sd <- df_sin_DANA %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(sd_PM2.5 = sd(PM2.5, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual_sd, aes(x = mes_num, y = sd_PM2.5)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la desviacion típica de PM2.5",
    subtitle = "Desviaciones típicas mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "Desviación típica de PM2.5 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Podemos observar una desviación típica constante a lo largo de los meses. Además, podemos concluir que los meses del año si que afectan a los valores de la variable PM2.5, probablemente relacionado con la temperatura.

#### Comportamiento por dia de la semana

```{r}
df_semanal_pm2.5 <- df_sin_DANA %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(media_PM2.5 = mean(PM2.5, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_pm2.5, aes(x = dia_num, y = media_PM2.5)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la concentración promedio de PM2.5",
    subtitle = "Promedios semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "Promedio de PM2.5 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

En este caso, parece ser que de martes a sabado los niveles de PM2.5 son similares pero que el domingo diminuyen considerablemente. 

Vamos a hacer lo mismo para la desviación típica de la variable.

```{r}
df_semanal_sd <- df_sin_DANA %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(sd_PM2.5 = sd(PM2.5, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_sd, aes(x = dia_num, y = sd_PM2.5)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la desviación típica de PM2.5",
    subtitle = "Desviaciones típicas semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "DS de PM2.5 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos que los lunes y martes tienen una desviación típica proporcional, menor que el resto de dias. Indicando que las mediciones de esos dias son más constantes.

Concluimos que si que existen diferencias segnificativas en los valores de PM2.5 dependiendo de el dia de la semana, probablemente debido al tráfico rodado.

#### Comportamiento por horas

```{r}
df_hourly_pm2.5 <- df_sin_DANA %>%
  group_by(Hora) %>%
  summarise(media_PM2.5 = mean(PM2.5, na.rm = TRUE)) %>%
  arrange(Hora)

ggplot(df_hourly_pm2.5, aes(x = factor(Hora, levels = 0:23), y = media_PM2.5, group = 1)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_discrete(drop = FALSE) +
  labs(
    title    = "Hourly evolution of the average PM2.5 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "Average of PM2.5 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Sorprendentemente, el comportamiento no se parece al de PM10. En este caso los valores disminuyen a las 12 del mediodía, e incrementan a las 16 de la tarde. Tiene sentido ya que las horas punta son cuando la mayoría de gente entra o sale de trabajar. Esto se verá más adelante.

Ahora vamos a ver como varían las desviaciones típicas.

```{r}
df_hourly_sd <- df_sin_DANA %>%
  group_by(Hora) %>%
  summarise(sd_PM2.5 = sd(PM2.5, na.rm = TRUE)) %>%
  mutate(Hora = as.numeric(as.character(Hora))) %>%
  arrange(Hora)

ggplot(df_hourly_sd, aes(x = Hora, y = sd_PM2.5)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(breaks = 0:23, limits = c(0, 23)) +
  labs(
    title    = "Hourly evolution of the strandard deviation of PM2.5",
    subtitle = "Standard deviation values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "SD of PM2.5 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Se puede destacar que las horas entre las 5 y las 10 tienen una desviación típica proporcional menor a el resto de valores. Lo que indica que a esa hora los valores de PM2.5 tienden a ser más constantes.

Concluimos que, la hora del día si que afecta a los valores de PM2.5, probablemente debido al tráfico rodado en la ciudad.

#### Faltantes

Primero de todo, vamos a ver el porcentaje de faltantes.

```{r}
sum(is.na(df$PM2.5)) / nrow(df) * 100
```

Tiene el mismo porcentaje de faltantes que PM10, y se mide en las mismas esatciones que PM10, como vimos en la preparacion de la base de datos. Se mide en todas las estaciones excepto:

- València - Bulevard Sud
- Paterna - CEAM
- València - Nazaret Met-2
- València - Vivers
- València-Conselleria Meteo

Vamos a ver el porcentaje de faltantes en las estaciones que la miden.

```{r}
resumen_total <- df %>%
  filter(Origen %in% estaciones_pm10) %>%
  summarise(
    total_obs     = n(),
    faltantes     = sum(is.na(PM2.5)),
    pct_faltantes = faltantes / total_obs * 100
  )

print(resumen_total)
```

Observamos que hay un 0.7% menos de faltantes en PM2.5 que en PM10.

Ahora que hemos visto sus distribuciones, es probable que las variables se midan en un mismo sensor, por lo que los faltantes estarían distribuidos igual en ambas variables.

Vamos a ver si los faltantes por año son iguales:

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_pm10,  
    is.na(PM2.5)                    
  ) %>%
  count(Año, name = "n_missing_PM2.5") %>%  
  ungroup() %>%
  mutate(
    total_missing_PM2.5 = sum(n_missing_PM2.5),            
    pct_total        = n_missing_PM2.5 / total_missing_PM2.5 * 100  
  ) %>%
  arrange(Año)

ggplot(df_plot, aes(x = factor(Año), y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de PM2.5 por año",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese año",
    x        = "Año",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x    = element_text(face = "bold"),
    plot.title     = element_text(face = "bold", hjust = 0.5),
    plot.subtitle  = element_text(hjust = 0.5)
  )
```

Como habíamos supuesto, la distribución de los faltantes de la variable PM2.5 por año, es similar a la de PM10. Con una mayor concentración en el año 2023.

Ahora vamos a ver su distribucion por meses para ver la diferencia entre PM10 y PM2.5.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_pm10) %>%              
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  filter(is.na(PM2.5)) %>%                              
  count(Mes, name = "n_missing") %>%       
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),                   
    pct_total     = n_missing / total_missing * 100    
  )

# 2) Gráfico
ggplot(df_plot, aes(x = Mes, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Porcentaje de valores faltantes de PM2.5 por mes",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese mes",
    x = "Mes",
    y = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5))
```

En el caso de los meses, la distribucion de los faltantes de ambos contaminantes son similares, en este caso estando un poco mas distribuidos.

Ahora vamos a hacer lo mismo para dias de la semana, que en PM10 estaban más o menos uniformemente distribuidos.

```{r}
df_plot <- df %>%
  filter(
    Origen   %in% estaciones_pm10,   
    is.na(PM2.5)                      
  ) %>%
  count(Dia_Semana, name = "n_missing") %>%  
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),          
    pct_total     = n_missing / total_missing * 100  
  ) %>%
  mutate(Dia_Semana = factor(Dia_Semana, levels = dias_orden)) %>%
  arrange(Dia_Semana)

# 2) Gráfico
ggplot(df_plot, aes(x = Dia_Semana, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de PM2.5 por día de la semana",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese día",
    x        = "Día de la semana",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

En este caso, volvemos a observar una distribución de los faltantes similar a la de PM10.

Por último veamos si por horas tienen una distribución similar, en PM10 era uniforme.

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_pm10,   
    is.na(PM2.5)           
  ) %>%
  count(Hora, name = "n_missing") %>%  
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),           
    pct_total     = n_missing / total_missing * 100  #
  ) %>%
  arrange(Hora)

ggplot(df_plot, aes(x = Hora, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  scale_x_continuous(breaks = 0:23) +
  labs(
    title    = "Porcentaje de valores faltantes de PM2.5 por hora del día",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en esa hora",
    x        = "Hora",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(face = "bold"),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

Como esperábamos, tienen una distribución muy similar. El hecho de que tengan muchas similitudes en las distribuciones de los faltantes puede indicar un patrón. 

Para si hay un patrón vamos a ver si un faltante se repite en otros años. Esto lo vamos a hacer siguiendo estos pasos:

-filtrar estaciones que miden la variable
- Seleccionar filas donde la variable es NA
- Agrupar por combinación de Mes, Dia y Hora
- Calcular el numero de años distintos con al menos ese NA y contruimos la lista de años
- Solo nos quedamos con los que se repiten en más de un año

```{r}
df_faltantes_pm2.5 <- df %>%
  filter(Origen %in% estaciones_pm10)

faltantes_recurrentes_pm2.5 <- df_faltantes_pm2.5 %>%
  filter(is.na(PM2.5)) %>%
  group_by(Mes, Dia, Hora) %>%
  summarise(
    n_años               = n_distinct(Año),
    Años_con_faltante    = paste(sort(unique(Año)), collapse = ", "),
    .groups              = "drop"
  ) %>%
  filter(n_años > 1) %>%        
  select(Mes, Dia, Hora, Años_con_faltante)

print(faltantes_recurrentes_pm2.5)
```

Podemos observar que si parece haber un patrón en los faltantes, ya que hay muchas fechas con el mismo faltante pero en otros años.

```{r}
df %>%
  mutate(missing = is.na(PM2.5)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c('TRUE' = "red", 'FALSE' = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de PM2.5",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()
```

Gracias a esta gráfica podemos ver más facilmente el patrón de faltantes de la variable PM2.5. Podemos también ver en que estaciones se ha medido la variable, su proporción de faltantes,... Tambien vemos que la distribución de los faltantes en PM2.5 es muy similar a la de PM10, como ya habiamos mencionado antes.

## SO2

Ahora vamos a analizar la variable SO2, la cual esta relacionada con las variables PM10 y PM2.5, ya que SO2 es precursor de sulfatos que contribuyen a la formación de material particulado (PM10 y PM10).

```{r}
hist(df$SO2, breaks = 30, col = "skyblue", main = "Histograma de SO2", xlab = "SO2 (µg/m³)")
```

Podemos observar una distribución extremadamente sesgada. Esto podría deberse a la presencia de datos atípicos o outliers, que son valores que se desvían significativamente de la tendencia general de los datos. Para confirmar esto, vamos a calcular algunos estadísticos descriptivos.

```{r}
summary(df$SO2)
```

El valor máximo de la variable es bastante alto en comparación a la media y mediana. Vamos a ver como se distribuye a lo largo del tiempo.

```{r}
ggplot(df, aes(x = FechaHora, y = SO2, group = 1)) +
  geom_line(color = "steelblue") +
  scale_x_datetime(
    date_breaks = "1 year",    
    date_labels = "%Y"        
  ) +
  labs(
    title = "Evolución temporal de SO2",
    x     = "Año",
    y     = expression(PM[SO2]~"(µg/m"^3*")")
  ) +
  theme_minimal()
```

En este caso parece ser que lso valores de la variable no se vierno afectados por la DANA. Pero se pueden observar unos cuantos picos alrededor de 2021. Vamos a ver que fechas son para poder estudiarlos más a fondo.

```{r}
fechas_valores_exceso <- df %>%
  filter(`SO2` > 100) %>%
  select(Fecha, Hora, Origen, `SO2`) %>%      
  arrange(Fecha)

print(fechas_valores_exceso)
```

Podemos observar que todos esos valores más elevados provienen de la misma estación, más o menos las mismas horas y meses cercanos. Es decir que podrían ser valores reales y no errores. Además tiene sentido, ya que el SO2 se produce por la combustión de combustibles fosiles en por ejemplo maquinaria pesada presente en puertos, como por ejemplo barcos, gruas, camiones,... 

Buscando por internet, hemos encontrado que Octubre, Noviembre y Diciembre el tráfico de contenedores aumento un 20%, lo cual pudo haber generado estos picos. Por eso, vamos a tratarlos como valore reales.

Ahora vamos a ver la distribución de la variable al aplicar una transformación logarítmica, ya que al principio nos sale una distribucion muy sesgada.

```{r}
df$log_SO2 <- log(df$SO2 + 1)

ggplot(df, aes(x = log_SO2)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(SO2)",
    x     = expression(log(SO[2]~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

La distribución mostrada es claramente unimodal y asimetrica a la derecha. Es decir, la mayoría de las medidas de SO2 durante el periodo analizado se sitúan en niveles bajos-moderados, con raras excursiones hacia valores altos que aparecen como la cola derecha del histograma. 

Dado que no hay normalidad no podremos aplicar ANOVA. Vamos a realizar un test para comprobar si hay homocedasticidad, para descartar por comleto el ANOVA.

Test de Levene

```{r}
leveneTest(log_SO2 ~ Origen, data = df)
```

Dado que el p-value es < 0.05, rechazamos hipotesis nula, y por tanto afirmamos heterogeniedad. Como no hay heterocedasticidad, no podemos realizar ANOVA.

#### Comportamiento por zonas

Vamos a ver la distribución del contaminante por zonas

```{r}
df %>%
  filter(!is.na(SO2)) %>%
  ggplot(aes(x = SO2)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de SO2 por estación",
      x     = "SO2 (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Observamos que la distribución de los datos en las zonas no varía casi nada, si se observa valore más altos en las estaciones del puerto, posiblemente debido al tráfico portuario. Vamos a hacer lo mismo pero para log(SO2).

```{r}
df %>%
  filter(!is.na(log_SO2)) %>%
  ggplot(aes(x = log_SO2)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de log(SO2) por estación",
      x     = "log(SO2) (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

En las distribuciones logaritmicas, si que se puede apreciar que existen diferencias significativas en algunas zonas. Esto lo veremos más adelnate.

Vamos a ver gráficamente las medias de SO2 para cada estación para asi ver si varia mucho los valores.

```{r}
no_tomar <- c("València Olivereta",
              "València - Centre",
              "València - Nazaret Met-2",
              "Benetusser UM",
              "València-Conselleria Meteo")

estaciones_so2 <- setdiff(unique(df$Origen), no_tomar)

df_so2 <- df %>%
  filter(Origen %in% estaciones_so2)

media_por_estacion <- df_so2 %>%
  group_by(Origen) %>%
  summarise(
    media_SO2 = mean(SO2, na.rm = TRUE),
    n_obs      = sum(!is.na(SO2))
  ) %>%
  ungroup() %>%
  arrange(desc(media_SO2)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(media_por_estacion, aes(x = Origen, y = media_SO2)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(media_SO2, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Media de SO2 por estación",
    subtitle = "Solo estaciones que miden SO2",
    x        = "Estación",
    y        = expression(Media~SO2~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(media_por_estacion$Origen, "=", media_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos que las medias varian entre 3 y 4 en todas las estaciones excepto en Massanassa, que es de 1.1. El hecho de que la mayoria de medias sean similares nos indica que los valores de SO2 son más estacionales que los de otros contaminantes, lo cual se debe a su ditribución unimodal.

Vamos a ver que sucede con las medianas.

```{r}
df_so2 <- df %>%
  filter(Origen %in% estaciones_so2)

mediana_por_estacion <- df_so2 %>%
  group_by(Origen) %>%
  summarise(
    mediana_SO2 = median(SO2, na.rm = TRUE),
    n_obs      = sum(!is.na(SO2))
  ) %>%
  ungroup() %>%
  arrange(desc(mediana_SO2)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(mediana_por_estacion, aes(x = Origen, y = mediana_SO2)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(mediana_SO2, 1)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Mediana de SO2 por estación sin la DANA",
    subtitle = "Solo estaciones que miden SO2",
    x        = "Estación",
    y        = expression(Media~SO2~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(mediana_por_estacion$Origen, "=", mediana_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Parecido a lo sucedido con la media, Massanassa tiene la mediana más baja mientras que el resto de estaciones tienen la misma mediana. Podemos deducir que en Massanassa los niveles de PM2.5 son bastante más bajos que en el resto. Esto vueelve a deberse a la distribución unimodal.

Vamos a hacer lo mismo para la desviación típica

```{r}
df_so2 <- df %>%
  filter(Origen %in% estaciones_so2)

sd_por_estacion <- df_so2 %>%
  group_by(Origen) %>%
  summarise(
    sd_SO2 = sd(SO2, na.rm = TRUE),
    n_obs      = sum(!is.na(SO2))
  ) %>%
  ungroup() %>%
  arrange(desc(sd_SO2)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(sd_por_estacion, aes(x = Origen, y = sd_SO2)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(sd_SO2, 2)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Desviación típica de SO2 por estación",
    subtitle = "Solo estaciones que miden SO2",
    x        = "Estación",
    y        = expression(SD~SO2~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(sd_por_estacion$Origen, "=", sd_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Lo que más llama la atención es que las dos estaciones situadas en el puerto, son las que mayor variabilidad tienen. Esto puede deberse a la actividad portuaria, ya que eso causa muchos picos y bajos, dependiendo del tráfico de barcos y camiones. 

Además, hay 4 estaciones con unas desviaciones típicas mucho más bajas que las demás. Estas zonas solo tienen valores en 2024 por lo que al haberse medido durante menos tiempo, es dificil que haya mucha variabilidad. 

Ahora vamos a ver los valores máximos y minimos de cada estación.

```{r}
df_so2 <- df %>%
  filter(Origen %in% estaciones_so2)

resumen_so2 <- df_so2 %>%
  group_by(Origen) %>%
  summarise(
    min_SO2 = min(SO2, na.rm = TRUE),
    max_SO2 = max(SO2, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(Origen)

print(resumen_so2)

ggplot(resumen_so2, aes(x = Origen)) +
  geom_linerange(aes(ymin = min_SO2, ymax = max_SO2), size = 1.5) +
  geom_point(aes(y = min_SO2), shape = 21, fill = "white", size = 3) +
  geom_point(aes(y = max_SO2), shape = 21, fill = "black", size = 3) +
  coord_flip() +
  labs(
    title = "Rango de valores de SO2 por estación",
    x     = "Estación",
    y     = expression(SO2~"(µg/m³)")
  ) +
  theme_minimal(base_size = 12)
```

Todas la estaciones, excepto València Port Moll Trans Ponent, tienen rangos muy pequeños y en valores muy bajos. La otra parece ser que sufrió algun episodio de contaminación extrema o algun error de medición, ya que valores tan altos son muy inusuales.

Ahora, vamos a estudiar si hay diferencias significativas en los valores de SO2 dependiendo de la estación de medición. Ya que no podemos usar un ANOVA, vamos a utilizar el test de Kruksal-Wallis para comprobar si exite al menos una diferencia entre varios origenes.

```{r}
kruskal.test(log_SO2 ~ Origen, data = df)
```

Dado que el p-values es inferior a 0.05, podemos rechazar la hipotesis nula y confirmar que hay evidencia de diferencias significativas entre distribuciones de SO2 según el Origen.

Ahora vamos a realizar el test de Dunn, para realizar las comparaciones por pares para saber que niveles de Origen difieren.

```{r}
df %>%
  dunn_test(log_SO2 ~ Origen, p.adjust.method = "bonferroni")
```
Todas las parejas de estaciones tienen diferencias significativas excepto las siguientes parejas:

- Catarroja UM	y Paiporta UM
- Catarroja UM	y Torrent-El Vedat
- Paiporta UM y	Sedavi UM
- Paiporta UM	y Torrent-El Vedat
- Paiporta UM	y València Port Moll Trans. Ponent
- Paterna - CEAM	y Quart de Poblet
- Sedavi UM	y Torrent-El Vedat
- Sedavi UM	y València Port llit antic Túria
- Sedavi UM	y València Port Moll Trans. Ponent
- València - Bulevard Sud	y València - Pista de Silla

Podemos observar que muchas de las que no tienen diferencias, y estuvieron afectadas por la DANA la mayoría. Luego las de los puertos tienen valores parecidos a las zonas afectadas por la DANA, debido a que en los puertos se genera mucho SO2 debido a la combustion de los barcos, camiones,...

Podemos concluir que, la zona si influye en las mediciones de SO2. Más adelante estudiaremos si puede deberse al tráfico o meteorología.

#### Comportamiento por timepo

Vamos a ver como se comporta el contaminante a lo largo del tiempo. Para ello, vamos a hacer un gráfico.

```{r}
df_anual_so2 <- df %>%
  mutate(Año = as.integer(as.character(Año))) %>%
  group_by(Año) %>%
  summarise(media_so2 = mean(SO2, na.rm = TRUE)) %>%
  arrange(Año)

ggplot(df_anual_so2, aes(x = Año, y = media_so2)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)
  ) +
  labs(
    title    = "Yearly evolution of the average SO2 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Year",
    y        = "Average of SO2 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Para este contaminante tambien se ve una disminución en 2020 pero mucho menos significativa.Pero en lineas generales, parece no variar mucho.

Vamos a hacer lo mismo para las desviaciones típicas.

```{r}
df_anual_so2_sd <- df %>%
  mutate(Año = as.integer(as.character(Año))) %>%
  group_by(Año) %>%
  summarise(sd_so2 = sd(SO2, na.rm = TRUE)) %>%
  arrange(Año)

ggplot(df_anual_so2_sd, aes(x = Año, y = sd_so2)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)
  ) +
  labs(
    title    = "Yearly evolution of the standard deviation of SO2",
    subtitle = "Standard deviation values from all stations in Valencia",
    x        = "Year",
    y        = "SD of SO2 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos que todos los años tienen desviaciones típicas similares, excepto 2020 que tiene una desviación típica proporcional muy alta en comparación a los demas años.

Pero, en lineas generales, podemos asumir que no hay una diferencia significativa en los valores de SO2 dependiendo de año.

#### Comportamiento por meses

```{r}
df_mensual_so2 <- df %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(media_so2 = mean(SO2, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual_so2, aes(x = mes_num, y = media_so2)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la concentración promedio de SO2",
    subtitle = "Promedios mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "Promedio de SO2 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

En este caso, parece que la distribución de los valores de SO2 es mas o menos uniforme, es decir que no varían mucho por el año. Vamos a ver como varían los valores en cada mes.

```{r}
df_mensual_so2_sd <- df %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(sd_so2 = sd(SO2, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual_so2_sd, aes(x = mes_num, y = sd_so2)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la ditribución típica de SO2",
    subtitle = "Desviaciónes típicas mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "SD de SO2 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Se observa claramente que en los meses de invierno, los valores de SO2 varían mucho más que en los meses de verano. Probablemente debido a la temperatura, lo cual estudiaremos más adelante.

En lineas generales, los valores del SO2 no se ven afectados por el mes del año, pero si que varian más en los meses de invierno.

#### Comportamiento por dia de la semana

```{r}
df_semanal_so2 <- df %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(media_so2 = mean(SO2, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_so2, aes(x = dia_num, y = media_so2)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la concentración promedio de SO2",
    subtitle = "Promedios semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "Promedio de SO2 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Parece ser que el valor de SO2 no varía casi segun el dia de la semana. Vamos a ver si los datos varían más o menos en los dias de la semana.

```{r}
df_semanal_so2_sd <- df %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(sd_so2 = sd(SO2, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_so2_sd, aes(x = dia_num, y = sd_so2)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la desviación típica de SO2",
    subtitle = "Desviaciones típicas semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "SD de SO2 (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

A lo largo de la semana los valores de SO2 suelen variar más o menos lo mismo excepto los martes, ya que proporcionalmente tiene una desviación típica superior. Cabe destacar que sucede algo parecido con la variable Año.

Podemos, con certeza, confirmar que SO2 no se ve afectado por los dias de la semana.

#### Comportamiento por horas

```{r}
df_hourly_so2 <- df %>%
  group_by(Hora) %>%
  summarise(media_so2 = mean(SO2, na.rm = TRUE)) %>%
  arrange(Hora)

ggplot(df_hourly_so2, aes(x = factor(Hora, levels = 0:23), y = media_so2, group = 1)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_discrete(drop = FALSE) +
  labs(
    title    = "Hourly evolution of the average SO2 concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "Average of SO2 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

El contaminante SO2 tiene un comportamiento constante excepto de 7 a 8 que hay un liegro pico. Esto podría deberse a que hay más picos en esas horas. Vamos a ver como varian los valore de SO2 segun la hora.

```{r}
df_hourly_so2_sd <- df %>%
  group_by(Hora) %>%
  summarise(sd_so2 = sd(SO2, na.rm = TRUE)) %>%
  arrange(Hora)

ggplot(df_hourly_so2_sd, aes(x = factor(Hora, levels = 0:23), y = sd_so2, group = 1)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_discrete(drop = FALSE) +
  labs(
    title    = "Hourly evolution of the stadard deviation SO2 concentration",
    subtitle = "Standard deviations values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "SD of SO2 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos unas desviaciones tipicas muy altas proporcionalmente en las horas entre las 6 y las 12, lo que puede deberse a la existencia de picos anormales en esas horas. Probalemente devidos al tráfico rodado.

Si que parece haber diferencias significativas para los valores entre las 6 y las 12, en el resto parecen comportarse más o menos igual.

#### Faltantes

Primero de todo, vamos a ver el porcentaje de faltantes.

```{r}
sum(is.na(df$SO2)) / nrow(df) * 100
```

Esta variable tiene menos valores faltantes que PM10 y PM2.5, vamos a ver en que estaciones tenemos más faltantes.

```{r}
df %>%
  filter(is.na(SO2)) %>%
  count(Origen) %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = reorder(Origen, -n), y = n)) +
  geom_bar(stat = "identity", fill = "firebrick") +
  labs(title = "Número de valores faltantes (NA) en SO2 por estación",
       x = "Estación (Origen)",
       y = "Número de NAs") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Resalta que hay varias estaciones con un número elevado de faltantes, lo cual se puede deber a que no se mide SO2 en esas estaciones. 

```{r}
resumen_so2 <- df %>%
  select(Origen, SO2) %>%
  pivot_longer(
    cols      = -Origen,
    names_to  = "Variable",
    values_to = "Valor"
  ) %>%
  filter(Variable == "SO2", !is.na(Valor)) %>%
  group_by(Variable) %>%
  summarise(
    num_estaciones    = n_distinct(Origen),
    lista_estaciones  = paste(sort(unique(Origen)), collapse = ", ")
  ) %>%
  ungroup()

print(resumen_so2)
```

La variable SO2 no se mide en las siguientes estaciones:

- València-Conselleria Meteo
- Benetusser UM
- València Olivereta
- València - Nazaret Met-2
- València - Centre

Ahora vamos a ver el los faltantes en las estaciones que si miden SO2.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_so2) %>%
  group_by(Origen) %>%
  summarise(
    n     = sum(is.na(SO2)),
    total = n(),                  
    pct   = n / total * 100     
  ) %>%
  arrange(desc(n))

ggplot(df_plot, aes(x = reorder(Origen, -n), y = n)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Número y % de valores faltantes (NA) en SO2 por estación",
    x     = "Estación (Origen)",
    y     = "Número de NAs"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Vemos que la gran mayoría de datos faltantes estan presentes en Torrent, ahora vamos a ver el porcentaje de faltantes que hay ahora.

```{r}
resumen_total_so2 <- df %>%
  filter(Origen %in% estaciones_so2) %>%
  summarise(
    total_obs     = n(),
    faltantes     = sum(is.na(SO2)),
    pct_faltantes = faltantes / total_obs * 100
  )

print(resumen_total_so2)
```

Al tener en cuenta solo las estaciones que miden SO2 vemos que hay tan solo un 2.8% de faltantes.

Vamos a ver si los faltantes por año son iguales:

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_so2,  
    is.na(CO)                    
  ) %>%
  count(Año, name = "n_missing_SO2") %>%  
  ungroup() %>%
  mutate(
    total_missing_SO2 = sum(n_missing_SO2),            
    pct_total        = n_missing_SO2 / total_missing_SO2 * 100  
  ) %>%
  arrange(Año)

ggplot(df_plot, aes(x = factor(Año), y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de SO2 por año",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese año",
    x        = "Año",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x    = element_text(face = "bold"),
    plot.title     = element_text(face = "bold", hjust = 0.5),
    plot.subtitle  = element_text(hjust = 0.5)
  )
```

Vemos que cada año hay mas o menos la misma cantidad de faltantes. Lo cual nos indica que el año no esta muy relacionado con la cantidad de faltantes de SO2.

Ahora vamos a ver su distribución por meses.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_so2) %>%              
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  filter(is.na(SO2)) %>%                              
  count(Mes, name = "n_missing") %>%       
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),                   
    pct_total     = n_missing / total_missing * 100    
  )

ggplot(df_plot, aes(x = Mes, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Porcentaje de valores faltantes de SO2 por mes",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese mes",
    x = "Mes",
    y = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5))
```

En el caso de los meses, la distribucion de los faltantes es parecida a los contaminantes PM10 y PM2.5, en este caso estando un poco mas distribuidos.

Ahora vamos a hacer lo mismo para dias de la semana, que en PM10 y PM2.5 estaban más o menos uniformemente distribuidos.

```{r}
df_plot <- df %>%
  filter(
    Origen   %in% estaciones_so2,   
    is.na(SO2)                      
  ) %>%
  count(Dia_Semana, name = "n_missing") %>%  
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),          
    pct_total     = n_missing / total_missing * 100  
  ) %>%
  mutate(Dia_Semana = factor(Dia_Semana, levels = dias_orden)) %>%
  arrange(Dia_Semana)

ggplot(df_plot, aes(x = Dia_Semana, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de SO2 por día de la semana",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese día",
    x        = "Día de la semana",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

En este caso, encontramos una distribución algo uniforme, teniendo más concentración a principio de la semana.

Por último veamos si por horas tienen una distribución similar, en PM10y PM2.5 era uniforme.

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_so2,   
    is.na(SO2)           
  ) %>%
  count(Hora, name = "n_missing") %>%  
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),           
    pct_total     = n_missing / total_missing * 100  #
  ) %>%
  arrange(Hora)

ggplot(df_plot, aes(x = Hora, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  scale_x_continuous(breaks = 0:23) +
  labs(
    title    = "Porcentaje de valores faltantes de SO2 por hora del día",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en esa hora",
    x        = "Hora",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(face = "bold"),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

Como esperábamos, tienen una distribución muy similar. El hecho de que tengan muchas similitudes en las distribuciones de los faltantes puede indicar un patrón. 

Para si hay un patrón vamos a ver si un faltante se repite en otros años. Esto lo vamos a hacer siguiendo estos pasos:

-filtrar estaciones que miden la variable
- Seleccionar filas donde la variable es NA
- Agrupar por combinación de Mes, Dia y Hora
- Calcular el numero de años distintos con al menos ese NA y contruimos la lista de años
- Solo nos quedamos con los que se repiten en más de un año

```{r}
df_faltantes_so2 <- df %>%
  filter(Origen %in% estaciones_so2)

faltantes_recurrentes_so2 <- df_faltantes_so2 %>%
  filter(is.na(SO2)) %>%
  group_by(Mes, Dia, Hora) %>%
  summarise(
    n_años               = n_distinct(Año),
    Años_con_faltante    = paste(sort(unique(Año)), collapse = ", "),
    .groups              = "drop"
  ) %>%
  filter(n_años > 1) %>%        
  select(Mes, Dia, Hora, Años_con_faltante)

print(faltantes_recurrentes_so2)
```

Podemos observar que hay fechas y horas con faltantes que se repiten en más de un año, y algunas fechas son las mismas que en PM10 y PM2.5, por lo que parece haber un patrón.

Vamos a visualizarlo de una forma más visual:

```{r}
df %>%
  mutate(missing = is.na(SO2)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c('TRUE' = "red", 'FALSE' = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de SO2",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()
```

Con esta gráfica podemos ver realmente los patrones, por ejemplo vemos al igual que en la tabla de antes que se repiten los faltanntes varios años.

## CO

Primero de todo vamos a ver la distribución de los datos de PM10.

```{r}
hist(df$CO, breaks = 30, col = "skyblue", main = "Histograma de CO", xlab = "CO (µg/m³)")
```

Se observa una distribución sesgada a la derecha, lo cual podría deberse a la presencia de datos atípicos o outliers, que son valores que se desvían significativamente de la tendencia general de los datos. Para confirmar esto, vamos a calcular algunos estadísticos descriptivos.

```{r}
summary(df$CO)
```

Podemos observar que el valor máximo de la variable es 2.3, lo cual es muchísimo más alto que la media y mediana. Vamos a ver a de donde vienen esos valores tan elevados. Para ello, vamos a ver la distribución del contaminante a lo largo del tiempo.

```{r}
ggplot(df, aes(x = FechaHora, y = CO, group = 1)) +
  geom_line(color = "steelblue") +
  scale_x_datetime(
    date_breaks = "1 year",    
    date_labels = "%Y"         
  ) +
  labs(
    title = "Evolución temporal de CO",
    x     = "Año",
    y     = expression(CO~"(µg/m"^3*")")
  ) +
  theme_minimal()
```

Parece se que la variable no se ve afectada por la DANA. Además, se ve un calro patrón con subidas y bajadas. Esto nos hace pensar que estará muy relacionada con temperatura.

Vamos a aplicar una transformación logarítmica para intentar normalizar la distribución.

```{r}
df$log_CO <- log(df$CO + 1)

ggplot(df, aes(x = log_CO)) +
  geom_histogram(
    bins  = 30,
    fill  = "lightblue",
    color = "white"
  ) +
  labs(
    title = "Histograma de log(CO)",
    x     = expression(log(CO~"(µg/"*m^3*")")),
    y     = "Frecuencia"
  ) +
  theme_minimal()
```

Al aplicar la transformación logaritmica nos queda una distribucion unimidal con fuerte sesgo a la derecha. Como tiene una dustribución parecida a la de SO2, vamos a comprobar su homogeniedad.

Test de Levene

```{r}
leveneTest(log_CO ~ Origen, data = df)
```

Dado que el p-value es < 0.05, rechazamos hipotesis nula, y por tanto afirmamos heterogeniedad. Como no hay ni normalidad ni heterocedasticidad, no podemos realizar ANOVA.

#### Comportamiento por zonas

Vamos a ver la distribucion de la variable por cada zona.

```{r}
df %>%
  filter(!is.na(CO)) %>%
  ggplot(aes(x = CO)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de CO por estación",
      x     = "CO (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Todas las zonas tienen una distribucion similar, solo que algunas tienen valores más altos que cambian un poco la distribucion. Vamos a ver como son las logaritmicas.

```{r}
df %>%
  filter(!is.na(log_CO)) %>%
  ggplot(aes(x = log_CO)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de log(CO) por estación",
      x     = "log(CO) (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Sucede lo mismo que en CO. Algunas zonas si parecen diferir del resto, esto lo veremos más adelante.

Vamos a ver gráficamente las medias de CO para cada estación para asi ver si varia mucho los valores.

```{r}
no_tomar_co <- c("València Olivereta",
              "València - Centre",
              "València - Nazaret Met-2",
              "Benetusser UM",
              "València-Conselleria Meteo",
              "València - Vivers",
              "València - Politècnic",
              "València - Bulevard Sud",
              "Quart de Poblet")

estaciones_co <- setdiff(unique(df$Origen), no_tomar_co)

df_co <- df %>%
  filter(Origen %in% estaciones_co)

media_por_estacion <- df_co %>%
  group_by(Origen) %>%
  summarise(
    media_CO = mean(CO, na.rm = TRUE),
    n_obs      = sum(!is.na(CO))
  ) %>%
  ungroup() %>%
  arrange(desc(media_CO)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(media_por_estacion, aes(x = Origen, y = media_CO)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(media_CO, 2)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Media de CO por estación",
    subtitle = "Solo estaciones que miden CO",
    x        = "Estación",
    y        = expression(Media~CO~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(media_por_estacion$Origen, "=", media_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos que las medias varian entre 0.1 y 0.17 en todas las estaciones. Parece ser que todas las estaciones tienen valores similares pero hay que tener en cuenta que sus valores son muy pequeños.

Vamos a ver que sucede con las medianas.

```{r}
df_co <- df %>%
  filter(Origen %in% estaciones_co)

mediana_por_estacion <- df_co %>%
  group_by(Origen) %>%
  summarise(
    mediana_CO = median(CO, na.rm = TRUE),
    n_obs      = sum(!is.na(CO))
  ) %>%
  ungroup() %>%
  arrange(desc(mediana_CO)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(mediana_por_estacion, aes(x = Origen, y = mediana_CO)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(mediana_CO, 2)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Mediana de CO por estación",
    subtitle = "Solo estaciones que miden CO",
    x        = "Estación",
    y        = expression(Mediana~CO~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(mediana_por_estacion$Origen, "=", mediana_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Parecido a lo sucedido con SO2, observamos que todas las estaciones tienen la misma mediana. Esto se debe a la distribución unimodal. Vamos a ver su desviación típica.

```{r}
df_co <- df %>%
  filter(Origen %in% estaciones_co)

sd_por_estacion <- df_co %>%
  group_by(Origen) %>%
  summarise(
    sd_CO = sd(CO, na.rm = TRUE),
    n_obs      = sum(!is.na(CO))
  ) %>%
  ungroup() %>%
  arrange(desc(sd_CO)) %>%
  mutate(Origen = factor(Origen, levels = Origen))

ggplot(sd_por_estacion, aes(x = Origen, y = sd_CO)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = round(sd_CO, 2)), 
            vjust = -0.5, size = 3) +
  labs(
    title    = "Desviación típica de CO por estación",
    subtitle = "Solo estaciones que miden CO",
    x        = "Estación",
    y        = expression(SD~CO~"(µg/m³)"),
    caption  = paste0("Número de observaciones válidas por estación:\n", 
                      paste(mediana_por_estacion$Origen, "=", mediana_por_estacion$n_obs, collapse = "; "))
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold", hjust = 0.5)
  )
```

Observamos que Paiporta tiene una variabilidad de 0, lo que probablemente se deba a un error, o que simplemente no hay muchos datos. Además se observa una diferencia muy grande entre las esatciones con mucha variabilidad y las que tienen pocas. Al igual que en SO2, son las estaciones cerca del puerto, lo que se puede justificar con la actividad portuaria.

```{r}
df_paiporta_co <- df %>%
  filter(Origen == "Paiporta UM") %>%
  select(FechaHora, CO)

df_paiporta_co
```

Observamos que CO tiene el mismo valor siempre en Paiporta, probablemente debido a un error en el sensor, ya que es muy raro que el valor no varie en absoluto.

Ahora vamos a ver los valores máximos y minimos de cada estación.

```{r}
df_co <- df %>%
  filter(Origen %in% estaciones_co)

resumen_co <- df_co %>%
  group_by(Origen) %>%
  summarise(
    min_CO = min(CO, na.rm = TRUE),
    max_CO = max(CO, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  arrange(Origen)

print(resumen_co)

ggplot(resumen_co, aes(x = Origen)) +
  geom_linerange(aes(ymin = min_CO, ymax = max_CO), size = 1.5) +
  geom_point(aes(y = min_CO), shape = 21, fill = "white", size = 3) +
  geom_point(aes(y = max_CO), shape = 21, fill = "black", size = 3) +
  coord_flip() +
  labs(
    title = "Rango de valores de CO por estación",
    x     = "Estación",
    y     = expression(CO~"(µg/m³)")
  ) +
  theme_minimal(base_size = 12)
```

Algo que llama a atención es que el valor mínimo en todas las estaciones es 0.1 excepto en Massanassa que es 0. Además, el rango de valore de el puerto es casi el doble que todas los otros rangos, lo que indica que ha habido algun pico muy considerable.

```{r}
df_co_gt2 <- df %>%
  filter(
    CO > 2
  ) %>%
  select(FechaHora, CO)

print(df_co_gt2)

valores_origen <- df %>%
  filter(
    Fecha  == as.Date("2020-09-22"),
    Origen == "València Port Moll Trans. Ponent"
  ) %>%
  mutate(Hora = factor(Hora, levels = unique(Hora))) %>%
  select(Hora, `CO`) %>%
  arrange(as.integer(as.character(Hora)))

ggplot(valores_origen, aes(x = Hora, y = `CO`, group = 1)) +
  geom_line(color = "steelblue") +
  geom_point(color = "steelblue", size = 2) +
  scale_x_discrete() +
  labs(
    title = "CO por hora el 2020-09-22 (Origen: València Port Moll Trans. Ponent)",
    x     = "Hora",
    y     = expression(CO~"(µg/m"^3*")")
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Se observa un pico muy alto durante 1 hora que luego vuelve a sus valores normales, esto podría tratarse de un error en el sensor.

Ahora, vamos a estudiar si hay diferencias significativas en los valores de CO dependiendo de la estación de medición. Ya que no podemos usar un ANOVA, vamos a utilizar el test de Kruksal-Wallis para comprobar si exite al menos una diferencia entre varios origenes.

```{r}
kruskal.test(log_CO ~ Origen, data = df)
```

Dado que el p-values es inferior a 0.05, podemos rechazar la hipotesis nula y confirmar que hay evidencia de diferencias significativas entre distribuciones de CO según el Origen.

Ahora vamos a realizar el test de Dunn, para realizar las comparaciones por pares para saber que niveles de Origen difieren.

```{r}
df %>%
  dunn_test(log_CO ~ Origen, p.adjust.method = "bonferroni")
```
Las estaciones con **** indican que difieren significativamente, las demás no tienen diferencias significativas. Esas estaciones, sin diferencias significativas, son las siguientes:

- Catarroja UM y Massanassa_UM
- Catarroja UM y Paiporta UM
- Catarroja UM y Sedavi UM
- Massanassa_UM	y Paiporta UM
- Massanassa_UM	y Sedavi UM
- Paiporta UM	y Sedavi UM
- Sedavi UM	y Torrent-El Vedat

Estas estaciones estan todas relativamente cercas unas de otras, y por ejemplo todas sufrieron mucho durante la DANA, lo que puede llevar a la conclusión de que se comportan similarmente y que no difieren entre ellas pero si entre las demás.

En conclusión, la zona si que influye  en los valores medidos de CO.

#### Comportamiento por timepo

Vamos a ver como se comporta el contaminante a lo largo del tiempo. Para ello, vamos a hacer un gráfico.

```{r}
df_anual_co <- df %>%
  mutate(Año = as.integer(as.character(Año))) %>%
  group_by(Año) %>%
  summarise(media_co = mean(CO, na.rm = TRUE)) %>%
  arrange(Año)

ggplot(df_anual_co, aes(x = Año, y = media_co)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)
  ) +
  labs(
    title    = "Yearly evolution of the average CO concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Year",
    y        = "Average of CO (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

En el caso de CO, observamos como de 2019 a 2022 los valores tienden a disminuir de una forma constante, pero hay un pico en 2023. Segun información que hemos encontrado en internet,de 2016 a 2022, se redujo la cantidad de carriles en varias zonas de valencia, lo que pudo causar esa disminución que se ve en la gráfica. Y en 2023 esa ley se retiró, lo que puedo causar ese pico en 2023. 

Vamos a ver como varían los valores en cada año.

```{r}
df_anual_co_sd <- df %>%
  mutate(Año = as.integer(as.character(Año))) %>%
  group_by(Año) %>%
  summarise(sd_co = sd(CO, na.rm = TRUE)) %>%
  arrange(Año)

ggplot(df_anual_co_sd, aes(x = Año, y = sd_co)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_continuous(
    breaks = 2019:2024,
    limits = c(2019, 2024)
  ) +
  labs(
    title    = "Yearly evolution of the standarad deviation CO concentration",
    subtitle = "Standard deviation values from all stations in Valencia",
    x        = "Year",
    y        = "SD of CO (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos que en procporciona los valores de cada año, la desviacion típica se matiene constante. Lo que sugiere que pese a que los valores bajan y aumentan dependiendo del año, su variación no cambia.

Con estas gráficas, podemos observar que si que existen diferencias significativas en los valores de CO.

#### Comportamiento por meses

```{r}
df_mensual_co <- df %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(media_co = mean(CO, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual_co, aes(x = mes_num, y = media_co)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la concentración promedio de CO",
    subtitle = "Promedios mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "Promedio de CO (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Podemos observar que la media de CO es más alta en los meses de frío, lo que puede deberse a que existe una relación entre CO y la temperatura. Esto los comprobaremos más adelante.

Vamos a ver que sucede con las desviaciones típicas.

```{r}
df_mensual_co_sd <- df %>%
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  group_by(Mes) %>%
  summarise(sd_co = sd(CO, na.rm = TRUE)) %>%
  arrange(Mes) %>%
  mutate(mes_num = as.integer(Mes))

ggplot(df_mensual_co_sd, aes(x = mes_num, y = sd_co)) +
  geom_area(fill = "#FFEB3B", alpha = 0.4) +       
  geom_line(color = "#FFC107", size = 1.2) +      
  geom_point(color = "#FFC107", size = 3) +
  scale_x_continuous(
    breaks = 1:12,
    labels = meses_orden,
    limits = c(1, 12)
  ) +
  labs(
    title    = "Evolución anual de la desviación típica de CO",
    subtitle = "Desviaciones típicas mensuales desde todas las estaciones en Valencia",
    x        = "Mes",
    y        = "SD de CO (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#FFC107"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos una gŕafica parecida a la de la media, por lo que la variación de los valores en cada mes es proporcionalmente igual en todos los mese.

Podemos confirmar que si que existe una relación entre los meses del año y los valores de CO. Probablemente debido a la temperatura, lo cual estudiaremos más adelante.

#### Comportamiento por dia de la semana

```{r}
df_semanal_co <- df %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(media_co = mean(CO, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_co, aes(x = dia_num, y = media_co)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la concentración promedio de CO",
    subtitle = "Promedios semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "Promedio de CO (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Podemos ver que la media de CO no varia mucho a lo largo de la semana, excepto el fin de semana que parece disminuir un poco. Esto puede deberse a que es un contaminante muy estatico, es decir que cuesta aumentar sus niveles.

```{r}
df_semanal_co_sd <- df %>%
  mutate(
    Dia_Semana = factor(Dia_Semana, levels = dias_orden, ordered = TRUE)
  ) %>%
  group_by(Dia_Semana) %>%
  summarise(sd_co = sd(CO, na.rm = TRUE)) %>%
  arrange(Dia_Semana) %>%
  mutate(dia_num = as.integer(Dia_Semana))

ggplot(df_semanal_co_sd, aes(x = dia_num, y = sd_co)) +
  geom_area(fill = "#2196F3", alpha = 0.4) +       
  geom_line(color = "#1976D2", size = 1.2) +      
  geom_point(color = "#1976D2", size = 3) +
  scale_x_continuous(
    breaks = 1:7,
    labels = dias_orden,
    limits = c(1, 7)
  ) +
  labs(
    title    = "Evolución semanal de la desviación estandar de CO",
    subtitle = "Desviaciones típicas semanales desde todas las estaciones en Valencia",
    x        = "Día de la semana",
    y        = "SD de CO (µg/m³)",
    caption  = "Fuente: datos de contaminación del aire"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#1976D2"),
    axis.text         = element_text(color = "gray20"),
    axis.text.x       = element_text(angle = 45, hjust = 1),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Las desviaciones típicas son, en proporción, constantes. En definitiva, no parece haber una diferencia significativa entre los valores de CO en cada dia de la semana. Pese a que el fin de semana, especialmente el domingo, si disminuyen un poco en comparación a el resto de la semana, pero una cantidad muy pequeña.

Esto podría deberse a muchas razones, como por ejemplo el tráfico, lo cual estudiaremos más adelante.

#### Comportamiento por horas

```{r}
df_hourly_co <- df %>%
  group_by(Hora) %>%
  summarise(media_co = mean(CO, na.rm = TRUE)) %>%
  arrange(Hora)

ggplot(df_hourly_co, aes(x = factor(Hora, levels = 0:23), y = media_co, group = 1)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_discrete(drop = FALSE) +
  labs(
    title    = "Hourly evolution of the average CO concentration",
    subtitle = "Average values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "Average of CO (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

El contaminante CO, tiene un comportamiento similar al de PM10. Un aumento sobre las 6 de la mañana y otro aumento hacia la noche. Esto puede deberse a el tráfico, ya que a esas horas la gente suele entrar y salir de trabajar.

Ahora vamos a ver como son las desviaciones típicas para cada hora del dia.

```{r}
df_hourly_co_sd <- df %>%
  group_by(Hora) %>%
  summarise(sd_co = sd(CO, na.rm = TRUE)) %>%
  arrange(Hora)

ggplot(df_hourly_co_sd, aes(x = factor(Hora, levels = 0:23), y = sd_co, group = 1)) +
  geom_area(fill = "#FF6E6E", alpha = 0.4) +
  geom_line(color = "#B22222", size = 1.2) +
  geom_point(color = "#B22222", size = 3) +
  scale_x_discrete(drop = FALSE) +
  labs(
    title    = "Hourly evolution of the standard deviation of CO ",
    subtitle = "Standard deviations values from all stations in Valencia",
    x        = "Hour of the day",
    y        = "SD of CO (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold", color = "#B22222"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60")
  )
```

Observamos la misma distribución que en la media, es decir que proporcionalmennte, los valores varían igual independientemente de la hora del día.

Podemos concluir que si que existen diferencias significativas entre los valores de CO por horas, probablemente debido al tráfico rodado. Esto se estudiará más adelante.

#### Faltantes

Primero de todo, vamos a ver el porcentaje de faltantes.

```{r}
sum(is.na(df$CO)) / nrow(df) * 100
```

Lo que llama más la atención es que esta variable tiene un porcentaje de nulos mucho superior a la de los otros contaminantes estudiados. Vamos a ver en que zonas hay más faltantes de esta variable.

```{r}
df %>%
  filter(is.na(CO)) %>%
  count(Origen) %>%
  arrange(desc(n)) %>%
  ggplot(aes(x = reorder(Origen, -n), y = n)) +
  geom_bar(stat = "identity", fill = "firebrick") +
  labs(title = "Número de valores faltantes (NA) en CO por estación",
       x = "Estación (Origen)",
       y = "Número de NAs") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Podemos observar que hay 8 estaciones con una cantidad muy alta de faltantes, lo cual puede deberse a que no se mide CO en esas estaciones. Vamos a inspeccionar que estaciones la miden.

```{r}
resumen_so2 <- df %>%
  select(Origen, CO) %>%
  pivot_longer(
    cols      = -Origen,
    names_to  = "Variable",
    values_to = "Valor"
  ) %>%
  filter(Variable == "CO", !is.na(Valor)) %>%
  group_by(Variable) %>%
  summarise(
    num_estaciones    = n_distinct(Origen),
    lista_estaciones  = paste(sort(unique(Origen)), collapse = ", ")
  ) %>%
  ungroup()

print(resumen_so2)
```

La variable CO no se mide en las siguientes estaciones:

- València-Conselleria Meteo
- Benetusser UM
- València - Vivers
- Quart de Poblet
- València Olivereta
- València - Nazaret Met-2
- València - Politècnic
- València - Centre
- València - Bulevard Sud

Ahora vamos a ver el los faltantes en las estaciones que si miden CO.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_co) %>%
  group_by(Origen) %>%
  summarise(
    n     = sum(is.na(CO)),
    total = n(),                  
    pct   = n / total * 100     
  ) %>%
  arrange(desc(n))

ggplot(df_plot, aes(x = reorder(Origen, -n), y = n)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct,1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Número y % de valores faltantes (NA) en CO por estación",
    x     = "Estación (Origen)",
    y     = "Número de NAs"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

Al igual que en los otros contaminantes, la gran mayoría de datos faltantes estan presentes en Torrent. Ahora vamos a ver el porcentaje de faltantes que hay ahora.

```{r}
resumen_total_co <- df %>%
  filter(Origen %in% estaciones_co) %>%
  summarise(
    total_obs     = n(),
    faltantes     = sum(is.na(CO)),
    pct_faltantes = faltantes / total_obs * 100
  )

print(resumen_total_co)
```

Observamos que tiene un 7% de faltantes, lo cual es más alto que PM2.5 y PM10. Para estudiar más a fondo la distribución de los faltantes, vamos a ver si los faltantes por año son iguales:

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_co,  
    is.na(CO)                    
  ) %>%
  count(Año, name = "n_missing_CO") %>%  
  ungroup() %>%
  mutate(
    total_missing_CO = sum(n_missing_CO),            
    pct_total        = n_missing_CO / total_missing_CO * 100  
  ) %>%
  arrange(Año)

ggplot(df_plot, aes(x = factor(Año), y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de CO por año",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese año",
    x        = "Año",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x    = element_text(face = "bold"),
    plot.title     = element_text(face = "bold", hjust = 0.5),
    plot.subtitle  = element_text(hjust = 0.5)
  )
```

Observamos que en 2023 hay una cantidad de faltantes mayor, y que en 2024 este valor disminuye mucho en comparación a el resto de años.

Ahora vamos a ver su distribucion por meses.

```{r}
df_plot <- df %>%
  filter(Origen %in% estaciones_co) %>%              
  mutate(Mes = factor(Mes, levels = meses_orden, ordered = TRUE)) %>%
  filter(is.na(CO)) %>%                              
  count(Mes, name = "n_missing") %>%       
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),                   
    pct_total     = n_missing / total_missing * 100    
  )

ggplot(df_plot, aes(x = Mes, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title = "Porcentaje de valores faltantes de CO por mes",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese mes",
    x = "Mes",
    y = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5))
```

En el caso de los meses, la distribucion de los faltantes es parecida a los contaminantes PM10, PM2.5 y SO2. Con incremento a lo largo de los meses, excepto Febrero.

Ahora vamos a hacer lo mismo para dias de la semana, que en PM10, PM2.5 y SO2 estaban más o menos uniformemente distribuidos.

```{r}
df_plot <- df %>%
  filter(
    Origen   %in% estaciones_co,   
    is.na(CO)                      
  ) %>%
  count(Dia_Semana, name = "n_missing") %>%  
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),          
    pct_total     = n_missing / total_missing * 100  
  ) %>%
  mutate(Dia_Semana = factor(Dia_Semana, levels = dias_orden)) %>%
  arrange(Dia_Semana)

ggplot(df_plot, aes(x = Dia_Semana, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  labs(
    title    = "Porcentaje de valores faltantes de CO por día de la semana",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en ese día",
    x        = "Día de la semana",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

En este caso, encontramos una distribución relativamente uniforme, teniendo una concentración de faltantes similar en cada dia.

Por último veamos si por horas tienen una distribución similar, en PM10, PM2.5 y SO2 era uniforme.

```{r}
df_plot <- df %>%
  filter(
    Origen %in% estaciones_co,   
    is.na(CO)           
  ) %>%
  count(Hora, name = "n_missing") %>%  
  ungroup() %>%
  mutate(
    total_missing = sum(n_missing),           
    pct_total     = n_missing / total_missing * 100  #
  ) %>%
  arrange(Hora)

ggplot(df_plot, aes(x = Hora, y = pct_total)) +
  geom_col(fill = "firebrick") +
  geom_text(aes(label = paste0(round(pct_total, 1), "%")),
            vjust = -0.5, size = 3) +
  scale_x_continuous(breaks = 0:23) +
  labs(
    title    = "Porcentaje de valores faltantes de CO por hora del día",
    subtitle = "Cada barra muestra qué % del total de NAs ocurre en esa hora",
    x        = "Hora",
    y        = "% de NAs respecto al total"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x  = element_text(face = "bold"),
    plot.title   = element_text(face = "bold", hjust = 0.5),
    plot.subtitle= element_text(hjust = 0.5)
  )
```

Como esperábamos, tienen una distribución muy similar. El hecho de que tengan muchas similitudes en las distribuciones de los faltantes puede indicar un patrón. 

Para si hay un patrón vamos a ver si un faltante se repite en otros años. Esto lo vamos a hacer siguiendo estos pasos:

-filtrar estaciones que miden la variable
- Seleccionar filas donde la variable es NA
- Agrupar por combinación de Mes, Dia y Hora
- Calcular el numero de años distintos con al menos ese NA y contruimos la lista de años
- Solo nos quedamos con los que se repiten en más de un año

```{r}
df_faltantes_co <- df %>%
  filter(Origen %in% estaciones_co)

faltantes_recurrentes_co <- df_faltantes_co %>%
  filter(is.na(CO)) %>%
  group_by(Mes, Dia, Hora) %>%
  summarise(
    n_años               = n_distinct(Año),
    Años_con_faltante    = paste(sort(unique(Año)), collapse = ", "),
    .groups              = "drop"
  ) %>%
  filter(n_años > 1) %>%        
  select(Mes, Dia, Hora, Años_con_faltante)

print(faltantes_recurrentes_co)
```

Podemos observar que hay fechas y horas con faltantes que se repiten en más de un año, y algunas fechas son las mismas que en PM10, PM2.5 y SO2, por lo que parece haber un patrón.

Vamos a ver todo esto explicado, en una única gráfica:

```{r}
df %>%
  mutate(missing = is.na(CO)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c('TRUE' = "red", 'FALSE' = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de SO2",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()
```

En esta gráfica, podemos ver todo lo anterior, las estaciones en las que no se mide, que fechas tienen faltantes en varias estaciones, si esa misma fecha tiene faltantes en otros años,...


## Conclusiónes

En líneas generales, las variables PM10 y PM2.5 presentan un comportamiento prácticamente idéntico: se miden en las mismas estaciones, tienen distribuciones muy parecidas y porcentajes de datos faltantes casi iguales —incluso la distribución de esos faltantes es muy similar—, y sus medias anuales, mensuales, diarias y horarias siguen patrones casi idénticos. Todo ello, unido a sus fuentes antropogénicas y naturales compartidas, sugiere una correlación muy fuerte entre ambas.

Por su parte, SO2 muestra una distribución de valores distinta a la de los partículas, con un perfil unimodal que denota cierta estabilidad en sus concentraciones. Sin embargo, al analizar sus medias por año, mes, día y hora, observamos una evolución paralela a la de PM2.5 y PM10 —aunque menos pronunciada—, lo que indica la presencia de algunas fuentes de emisión comunes.

La variable CO también presenta una distribución unimodal, similar a la de SO2, y su comportamiento temporal se asemeja al del resto de contaminantes por compartir orígenes de generación. Lo más destacable de CO es que su proporción de valores faltantes es casi el doble que en las PM10 y PM2.5, y casi tres veces la de SO2.

Todos los contaminantes se ven afectados por las zonas de medición ya que existen diferencias significativas.

En todos estos contaminantes hay un patrón en los datos ausentes, pues en ocasiones coinciden fechas con faltantes en más de un año.

De cara a los estudios posteriores, esperamos que todas las variables estén correlacionadas entre sí, con una relación especialmente intensa entre PM10 y PM2.5, y algo menos marcada entre SO2 y CO.




