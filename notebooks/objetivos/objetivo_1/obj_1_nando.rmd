---
title: "Estudio Contaminantes Nando"
output: html_document
date: "2025-05-16"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(ggplot2)
library(naniar)
library(lubridate)
library(zoo)
library(stringr)
library(emmeans)
library(arrow)
library(forecast)
library(car)
library(lmtest)
library(emmeans)
```


Vamos a carcterizar los contaminantes individualmente.

Primero de todo, vamos a cargar la base de datos.

```{r}
df_NOs <- read_parquet("../../../data/cleaned/calidad_aire/base_para_obj1.parquet")
df_NOs$FechaHora <- as.POSIXct(df_NOs$FechaHora, format = "%Y-%m-%d %H:%M:%S")
df_NOs$Origen <- as.factor(df_NOs$Origen)
```

# NOx, NO2 y NO

## Distribución

Primero de todo vamos a ver la distribución de los datos de estos tres contaminantes individualmente.

```{r}
hist((df_NOs$NOx), breaks = 100, main = "Distribución de NOx", xlab = "NOx", ylab = "Frecuencia")
hist((df_NOs$NO2), breaks = 100, main = "Distribución de NO2", xlab = "NO2", ylab = "Frecuencia")
hist((df_NOs$NO), breaks = 100, main = "Distribución de NO", xlab = "NO", ylab = "Frecuencia")
```

Las 3 variables tienen una distribución exponencial. Además, vemos que para el caso del $NO$, la distribución está más sesgada a la derecha que para el $NO_2$ y el $NO_x$. Esto es debido a que el $NO$ se oxida rápidamente a $NO_2$, lo que provoca que el $NO$ tenga una concentración más baja en comparación con el $NO_2$.

Además, sabemos que el $NO_x$ es el conjunto de todos los óxidos de nitrógeno, y se demuestra en la gráfica que el $NO_x$ es la suma de los dos anteriores aproximadamente, ya que no se ha medido la presencia de otros óxidos de nitrógeno porque no son tan significantes en la contaminación del aire.

## Comportamiento a lo largo del tiempo

Vamos a ver cómo se comportan estos contaminantes a lo largo del tiempo.

```{r}
ggplot(df_NOs, aes(x = FechaHora)) +
  geom_line(aes(y = NOx, color = "NOx")) +
  geom_line(aes(y = NO2, color = "NO2")) +
  geom_line(aes(y = NO, color = "NO")) +
  labs(title = "Contaminantes NOx, NO2 y NO a lo largo del tiempo",
       x = "Fecha y Hora",
       y = "Concentración (µg/m³)",
       color = "Contaminante") +
  theme_minimal()
```

Podemos ver que los tres contaminantes tienen un comportamiento similar a lo largo del tiempo, con picos de concentración en los mismos momentos. Esto es debido a que los tres contaminantes están relacionados entre sí y provienen de las mismas fuentes de emisión, como el tráfico y la industria.

Además, los tres tienen la misma tendencia cada año, con picos en invierno y mínimos en verano. 

En el año 2020, a partir de la época COVID, se registran valores que parecen ligeramente inferiores al resto de los años. Por ejemplo, en el inicio de 2021, pese a que se repite el patrón de todos los años, se hace con una menor concentración de estos contaminantes.
Aproximadamente en noviembre de 2024 hay un pico repentino que no se repite en el resto de los años. Esto es debido a la DANA que hubo en esa época, que provocó una gran cantidad de lluvias y tormentas en la región, lo que puede haber afectado a la concentración de estos contaminantes en el aire.

Más adelante intentaremos darle una explicación a este patrón.

### Años

Vamos a calcular el promedio anual de cada contaminante para ver si hay alguna diferencia significativa entre años.

```{r}
df_NOs_anual <- df_NOs %>%
  group_by(year = year(FechaHora)) %>%
  summarise(across(c("NOx", "NO2", "NO"), mean, na.rm = TRUE)) %>%
  filter(!is.na(year)) %>%
  ungroup()
```

```{r}
df_long <- df_NOs_anual %>%
  pivot_longer(
    cols      = c("NO", "NO2", "NOx"),
    names_to  = "Gas",
    values_to = "Concentracion"
  )

# 2) Gráfico con áreas superpuestas, líneas y puntos
ggplot(df_long, aes(x = year, y = Concentracion, 
                    group = Gas, fill = Gas, color = Gas)) +
  geom_area(alpha = 0.4, position = "identity") +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_x_continuous(breaks = 2019:2024, limits = c(2019, 2024)) +
  scale_fill_manual(
    values = c(
      NO  = "#FFD580",
      NO2 = "#6EC6FF",
      NOx = "#FF6E6E"
    )
  ) +
  scale_color_manual(
    values = c(
      NO  = "#FF8C00",
      NO2 = "#4682B4",
      NOx = "#B22222"
    )
  ) +
  labs(
    title    = "Evolución anual de la concentración media de NO, NO2 y NOx",
    subtitle = "Valores medios de todas las estaciones en Valencia",
    x        = "Año",
    y        = "Concentración media (µg/m³)",
    fill     = "Gas",
    color    = "Gas",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60"),
    legend.position   = "bottom"
  )
```

Como era de esperar, los tres contaminantes tienen un comportamiento similar a lo largo de los años, con picos de concentración en los mismos momentos. Esto es debido a que los tres contaminantes están relacionados entre sí y provienen de las mismas fuentes de emisión, como el tráfico y la industria.

No obstante, el $NO$ tiene menos variación que el $NO_2$ y el $NO_x$, y esto es debido a que este se oxida rápidamente a $NO_2$.

Por otro lado, existe una tendencia en los tres contaminantes de disminuir su concentración a lo largo de los años. Esto puede ser debido a la implementación de políticas de reducción de emisiones y al aumento de la conciencia ambiental. Además, destaca la bajada importante en 2020 y 2021 por la época COVID, pero la tendencia a largo plazo es de bajada. 


### Meses

```{r}
df_NOs_mensual <- df_NOs %>%
  mutate(
    month = month(FechaHora, label = TRUE, abbr = TRUE)
  ) %>%
  group_by(month) %>%
  summarise(
    NO  = mean(NO,  na.rm = TRUE),
    NO2 = mean(NO2, na.rm = TRUE),
    NOx = mean(NOx, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols      = c("NO","NO2","NOx"),
    names_to  = "Gas",
    values_to = "Concentracion"
  ) %>%
  slice(1:(n() - 3))

# 2) Gráfico tipo área/línea/punto por mes
ggplot(df_NOs_mensual,
       aes(x = month, y = Concentracion,
           group = Gas, fill = Gas, color = Gas)) +
  geom_area(alpha = 0.4, position = "identity") +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_fill_manual(
    values = c(
      NO  = "#FFD580",
      NO2 = "#6EC6FF",
      NOx = "#FF6E6E"
    )
  ) +
  scale_color_manual(
    values = c(
      NO  = "#FF8C00",
      NO2 = "#4682B4",
      NOx = "#B22222"
    )
  ) +
  labs(
    title    = "Evolución media mensual de NO, NO2 y NOx",
    subtitle = "Media agregada sobre todos los años",
    x        = "Mes",
    y        = "Concentración media (µg/m³)",
    fill     = "Gas",
    color    = "Gas",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60"),
    legend.position   = "bottom"
  )
```

En la evolución media mensual de los NOs se da el mismo comportamiento que en la evolución anual. Vemos además que en la época de invierno los valores son mucho más altos que en verano, mientras que en los meses de primavera y otoño los valores son intermedios entre los que se dan en invierno y verano.

Cuando hagamos el cruce con tráfico y contaminación le daremos una explicación a este comportamiento estacional.

### Días

```{r}
df_NOs_diario <- df_NOs %>%
  mutate(weekday = wday(FechaHora, label = TRUE, abbr = TRUE)) %>%
  group_by(weekday) %>%
  summarise(
    NO  = mean(NO,  na.rm = TRUE),
    NO2 = mean(NO2, na.rm = TRUE),
    NOx = mean(NOx, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols      = c("NO","NO2","NOx"),
    names_to  = "Gas",
    values_to = "Concentracion"
  ) %>%
  slice(1:(n() - 3)) 

ggplot(df_NOs_diario,
       aes(x = weekday, y = Concentracion,
           group = Gas, fill = Gas, color = Gas)) +
  geom_area(alpha = 0.4, position = "identity") +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_fill_manual(
    values = c(
      NO  = "#FFD580",
      NO2 = "#6EC6FF",
      NOx = "#FF6E6E"
    )
  ) +
  scale_color_manual(
    values = c(
      NO  = "#FF8C00",
      NO2 = "#4682B4",
      NOx = "#B22222"
    )
  ) +
  labs(
    title    = "Concentración media de NO, NO2 y NOx por día de la semana",
    subtitle = "Agregado sobre todos los años",
    x        = "Día de la semana",
    y        = "Concentración media (µg/m³)",
    fill     = "Gas",
    color    = "Gas",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60"),
    legend.position   = "bottom"
  )
```

Los 3 contaminantes tienen el mismo comportamiento entre ellos. Entre los días de la semana, vemos como entre semana los valores son mucho más altos que los fines de semana, donde decae bastante la concentración de los contaminantes. 

### Horas

```{r}
df_NOs_horario <- df_NOs %>%
  mutate(hour = hour(FechaHora)) %>%
  group_by(hour) %>%
  summarise(
    NO  = mean(NO,  na.rm = TRUE),
    NO2 = mean(NO2, na.rm = TRUE),
    NOx = mean(NOx, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(
    cols      = c("NO","NO2","NOx"),
    names_to  = "Gas",
    values_to = "Concentracion"
  ) %>%
  slice(1:(n() - 3)) 

ggplot(df_NOs_horario, 
       aes(x = hour, y = Concentracion, 
           group = Gas, fill = Gas, color = Gas)) +
  geom_area(alpha = 0.4, position = "identity") +
  geom_line(size = 1.2) +
  geom_point(size = 3) +
  scale_x_continuous(breaks = 0:23, limits = c(0,23)) +
  scale_fill_manual(
    values = c(
      NO  = "#FFD580",
      NO2 = "#6EC6FF",
      NOx = "#FF6E6E"
    )
  ) +
  scale_color_manual(
    values = c(
      NO  = "#FF8C00",
      NO2 = "#4682B4",
      NOx = "#B22222"
    )
  ) +
  labs(
    title    = "Concentración media de NO, NO2 y NOx por hora del día",
    subtitle = "Media agregada sobre todos los años",
    x        = "Hora del día",
    y        = "Concentración media (µg/m³)",
    fill     = "Gas",
    color    = "Gas",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background   = element_rect(fill = "white", color = NA),
    panel.background  = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major  = element_line(color = "gray80"),
    panel.grid.minor  = element_blank(),
    axis.title        = element_text(face = "bold"),
    axis.text         = element_text(color = "gray20"),
    plot.title        = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle     = element_text(color = "gray40", hjust = 0.5),
    plot.caption      = element_text(size = 8, color = "gray60"),
    legend.position   = "bottom"
  )
```

Para las horas, vemos que los tres NOs siguen las mismas tendencias, pero en el caso de $NO_x$ en la franja de 6 a 10 está mucho más pronunciada la concentración en comparación con los otros dos. Más adelante intentaremos buscarle una explicación a ese fenómeno.

Por otro lado, vemos que el día se puede dividir en cuatro grupos:

- De 0 a 5
- De 6 a 10
- De 11 a 16
- De 17 a 23

Al igual que antes, también le daremos una explicación al cruzar los contaminantes con otros factores.

## Comportamiento de los valores faltantes

Antes de pasar a estudiar el comportamiento por zonas, vamos a ver cómo se comportan los valores faltantes de estos contaminantes. Entendiendo esto, podríamos hacer una imputación correcta y precisa de los faltantes para potenciar posteriormente el análisis.

En primer lugar, vamos a ver el porcentaje de faltantes que tenemos para cada variable.

```{r}
df_NOs %>% summarise(across(c("NOx", "NO2", "NO"), ~ sum(is.na(.)) / n() * 100))
```

El porcentaje de faltantes no es demasiado alto. Vamos a profundizar un poco más en el análisis de los valores faltantes viendo como se distribuyen por zonas. 

### Faltantes por zonas

```{r}
missing_values_zona <- df_NOs %>%
  group_by(Origen) %>%
  summarise(across(c("NOx", "NO2", "NO"), ~ sum(is.na(.)) / n() * 100)) %>%
  pivot_longer(cols = c("NOx", "NO2", "NO"), names_to = "Contaminante", values_to = "Porcentaje_Faltantes")
missing_values_zona <- missing_values_zona %>%
  arrange(Porcentaje_Faltantes, Origen, Contaminante)
missing_values_zona
```

Las estaciones "*València - Nazaret Met-2*" y "*València-Conselleria Meteo*" no tienen datos de los $NO_x$. Por lo tanto, para el análisis de estos contaminantes no vamos a considerar estas dos estaciones.

```{r}
df_NOs = df_NOs %>%
  filter(Origen != "València - Nazaret Met-2" & Origen != "València-Conselleria Meteo")
```


Por otro lado, las estaciones tienen todas menos de un 3% de faltantes, a excepción de "*Torrent-El Vedat*" y "*Benetusser UM*", que tienen un 41% y 60% respectivamente. Pese a ser valores ligeramente altos, vamos a incluirlas en el análisis para minimizar la pérdida de información y ver si podemos imputar los valores faltantes de forma correcta.

### Distribución de los valores faltantes

Vamos a ver cómo se distribuyen los valores faltantes de estos contaminantes a lo largo del tiempo, con el objetivo de detectar si hay algún patrón en la distribución de los valores faltantes.

```{r}
df_NOs %>%
  mutate(missing = is.na(NOx)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c(`TRUE` = "red", `FALSE` = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de NOx",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()

df_NOs %>%
  mutate(missing = is.na(NO)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c(`TRUE` = "red", `FALSE` = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de NOx",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()

df_NOs %>%
  mutate(missing = is.na(NO2)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c(`TRUE` = "red", `FALSE` = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de NOx",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()
```

A la vista del gráfico, no se puede detectar ningún patrón en la distribución de los faltantes para cada variable individualmente, ya sea entre estaciones, entre años o en el conjunto de los dos.

Por otro lado, sí que vemos que los faltantes son los mismos para las tres variables óxidos de nitrógeno.


## Comportamiento por zonas

Vamos a intentar entender el comportamiento de estas variables en las distintas zonas donde se miden. 

Para ellos vamos a realizar un ANOVA intentando ver si hay alguna diferencia significativa entre zonas.


### NO

#### Distribución

En primer lugar vamos a ver la distribución de los valores de $NO$ en función de la estación para evitar inconsistencias.

```{r}
df_NOs %>%
  filter(!is.na(NO)) %>%
  ggplot(aes(x = NO)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de NO por estación",
      x     = "NO (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

No hay ninguna estación en la que la distribución sea distinta de las otras, aunque sí que cambia el grado de acentuación de la distribución de las estaciones. Por lo tanto, podemos realizar el ANOVA sin ningún problema.

#### ANOVA 1

```{r}
anova_NO <- aov(NO ~ Origen, data = df_NOs)
summary(anova_NO)
```

Vemos que hay diferencias entre, al menos una de las estaciones. Ahora vamos a ver si se cumplen las hipótesis del ANOVA:

1. Normalidad de los residuos
2. Homocedasticidad (varianzas iguales)
3. Independencia de los residuos
Detección de valores influyentes

```{r}
par(mfrow = c(1, 1))
plot(anova_NO)
```

```{r}
dw <- dwtest(anova_NO)
print(dw)
acf(anova_NO$residuals, main = "ACF de los residuos")
```

El anova no cumple con ninguna de las hipótesis iniciales del ANOVA. Vamos a intentar darle una explicación a cada una de ellas e intentar solucionarlo.

1. *Normalidad de los residuos:* Pese a que el anova es bastante robusto frente a esta hipótesis, se observa que tiene demasiada asimetría positiva como para validar esta hipótesis. Una posible solución es aplicar una transformación logarítmica a la variable $NO$ para intentar normalizar los residuos.

2. *Homocedasticidad:* La homocedasticidad no se cumple, ya que los residuos tienen una varianza creciente a medida que aumenta el valor de la variable dependiente. Esto puede ser debido a la presencia de valores atípicos o a la falta de normalidad de los residuos. Una posible solución es aplicar una transformación logarítmica a la variable $NO$ para intentar homogeneizar las varianzas.

3. *Independencia de los residuos:* La independencia de los residuos no se cumple, ya que se observa un patrón de subidas y bajadas en los residuos a lo largo del tiempo. Esto puede ser debido a que, como se ha visto al principio, la distribución del contaminante $NO$ tiene un comportamiento estacional que se repite todos los años, lo que provoca que los residuos no sean independientes entre sí. Una posible solución es eliminar la temporalidad cogiendo una muestra de días aleatorios, y de todos ellos la misma hora.

Teniendo todo esto en cuenta, vamos a centrar el anova solo en 100 días aleatorios a las 12:00 del año 2023, que es el que recoge datos de más estaciones y evita episodios anómalos como el COVID-19 y la DANA. Además, vamos a aplicar el logaritmo de la variable $NO$ para intentar normalizar los residuos y homogeneizar las varianzas.

#### ANOVA 2

```{r}
# Seleccionar 100 filas aleatorias del año 2023 a las 12:00 el día lunes
set.seed(123) # Para reproducibilidad
df_NOs_2023 = df_NOs %>%
  filter(FechaHora >= "2023-01-01" & FechaHora < "2024-01-01") %>%
  filter(hour(FechaHora) == 12) %>%
  filter(wday(FechaHora) == 2) %>%
  sample_n(50)
df_NOs_2023$NO_log = log(df_NOs_2023$NO)
```


```{r}
anova_NO_2023 <- aov(NO_log ~ Origen, data = df_NOs_2023)
summary(anova_NO_2023)
```

```{r}
par(mfrow = c(1, 1))
plot(anova_NO_2023)
```

```{r}
dw <- dwtest(anova_NO_2023)
print(dw)
```

```{r}
leveneTest(anova_NO_2023)
```

Tras realizar los cambios propuestos del anova 1, ahora sí que se cumplen las hipótesis del anova. Como el test F ha resultado significativo, rechazamos $H_0$ y aceptamos que hay diferencias significativas entre al menos una de las estaciones. Para ver dónde están estas diferencias, vamos a realizar un test de comparación de medias. Concretamente, vamos a usar el test de Tukey, que es moderadamente conservador y tiene un buen control del error tipo I.

```{r}
Tukey_NO <- TukeyHSD(anova_NO_2023, "Origen", conf.level = 0.95)
Tukey_NO
```

Las estaciones entre las que hay una diferencia significativa de la concentración de $NO$ son las siguientes:

- València Olivereta-València - Av. França
- València Olivereta-València - Vivers
- València Olivereta-València - Politècnic 
- València Olivereta-València - Molí del Sol



### NO2

#### Distribución

```{r}
df_NOs %>%
  filter(!is.na(NO2)) %>%
  ggplot(aes(x = NO2)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de NO2 por estación",
      x     = "NO2 (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

La distribución por estación de $NO_2$ es muy parecida a la de $NO$. Sin embargo, la estación "Benetusser UM" tiene una distribución más normal que las demás. Vamos a tener esto en cuenta por si saliera alguna anomalía en el anova.

#### ANOVA 

Como hemos visto en la distribución y comportamiento a lo largo del tiempo, los tres óxidos de nitrógeno tienen un comportamiento muy parecido entre ellos. Por lo tanto, vamos a realizar el anova directamente con el logaritmo de $NO_2$ y eliminando la dimensión del tiempo.

```{r}
df_NOs_2023$NO2_log = log(df_NOs_2023$NO2)
anova_NO2_2023 <- aov(NO2_log ~ Origen, data = df_NOs_2023)
summary(anova_NO2_2023)
```

```{r}
par(mfrow = c(1, 1))
plot(anova_NO2_2023)
```

```{r}
dw <- dwtest(anova_NO2_2023)
print(dw)
```

```{r}
leveneTest(anova_NO2_2023)
```

El anova cumple con las hipótesis iniciales. Como el test F ha resultado significativo, rechazamos $H_0$ y aceptamos que hay diferencias significativas entre al menos una de las estaciones. Para ver dónde están estas diferencias, vamos a realizar un test de comparación de medias. Concretamente, vamos a usar el test de Tukey, que es moderadamente conservador y tiene un buen control del error tipo I.

```{r}
Tukey_NO2 <- TukeyHSD(anova_NO2_2023, "Origen", conf.level = 0.95)
Tukey_NO2
```

Las estaciones entre las que hay una diferencia significativa de la concentración de $NO_2$ son las siguientes:

- València - Centre-Quart de Poblet
- València Olivereta-Quart de Poblet
- València - Vivers-València - Centre
- València Port Moll Trans. Ponent-València - Centre
- València Olivereta-València - Vivers
- València Port Moll Trans. Ponent-València Olivereta


### NOx

#### Distribución

```{r}
df_NOs %>%
  filter(!is.na(NOx)) %>%
  ggplot(aes(x = NOx)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de NOx por estación",
      x     = "NOx (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```

Igual que con la variable $NO$, las distribuciones entre estaciones para la variable $NO_x$ son muy parecidas. Sin embargo, en este caso la estación "Benetusser UM" tambień tiene una distribución ligeramente distinta a las demás, acumulando mayor presencia de datos extremos en la cola derecha. Vamos a realizar el anova y ver si hay alguna anomalía con esta estación.

#### ANOVA

Igual que en el caso del $NO_2$, vamos a realizar el anova directamente con el logaritmo de $NO_x$ y eliminando la dimensión del tiempo.

```{r}
df_NOs_2023$NOx_log = log(df_NOs_2023$NOx)
anova_NOx_2023 <- aov(NOx_log ~ Origen, data = df_NOs_2023)
summary(anova_NOx_2023)
```


```{r}
par(mfrow = c(1, 1))
plot(anova_NOx_2023)
```


```{r}
dw <- dwtest(anova_NOx_2023)
print(dw)
```


```{r}
leveneTest(anova_NOx_2023)
```

En este caso también se validan las hipótesis iniciales del anova. Como el test F ha resultado significativo, rechazamos $H_0$ y aceptamos que hay diferencias significativas entre al menos una de las estaciones. Para ver dónde están estas diferencias, vamos a realizar un test de comparación de medias. Concretamente, vamos a usar el test de Tukey, que es moderadamente conservador y tiene un buen control del error tipo I.

```{r}
Tukey_NOx <- TukeyHSD(anova_NOx_2023, "Origen", conf.level = 0.95)
Tukey_NOx
```


Las estaciones entre las que hay una diferencia significativa de la concentración de $NO_x$ son las siguientes:

- València Olivereta-Paterna - CEAM
- València - Centre-Quart de Poblet
- València Olivereta-Quart de Poblet
- València Olivereta-València - Av. França
- València - Vivers-València - Centre
- València Port Moll Trans. Ponent-València - Centre
- València Olivereta-València - Politècnic
- València Olivereta-València - Vivers
- València Port Moll Trans. Ponent-València Olivereta


### Conclusiones comportamiento zonas

- Para los tres contaminantes, la estación "València Olivereta" es la que más diferencias significativas presenta con distitnas estaciones.

- El anova solo se ha hecho para el instante de tiempo de los lunes de 2023 a las 12:00. Habría que coger otros instantes de tiempo y ver si cambian los resultados.


# O3

## Distribución

### General

```{r}
hist((df_NOs$O3), breaks = 100, main = "Distribución de O3", xlab = "O3", ylab = "Frecuencia")
```

La variable $O_3$ tiene una distribución peculiar, porque parece tiene una parte con una distribución normal y parece haber una segunda población a la izquierda que se juntan y se convierten en una distribución bimodal. 

Sabemos que el grado de formación del ozono se ven muy incrementados con el au-
mento de la radiación solar, las emisiones antropogénicas de precursores y el ciclo
biológico de emisiones biogénicas de COVs. También sabemos que sus niveles son superiores en la periferia de las ciudades y en zonas rurales, y que los fines de semana aumenta su presencia.

A partir de esta información vamos a ver la distribución del $O_3$ en función de la estación para confirmar la presencia de dos poblaciones.

### Distribución por estación

```{r}
df_NOs %>%
  filter(!is.na(O3)) %>%
  ggplot(aes(x = O3)) +
    geom_histogram(bins = 100,
                   fill = "#6EC6FF",
                   color = "red",
                   alpha = 0.7) +
    facet_wrap(~ Origen, scales = "free_y") +
    labs(
      title = "Distribución de O3 por estación",
      x     = "O3 (µg/m³)",
      y     = "Frecuencia"
    ) +
    theme_minimal() +
    theme(
      strip.text = element_text(face = "bold"),
      axis.title = element_text(face = "bold")
    )
```


La distribución de $O_3$ en función de la estación es muy parecida a la distribución general. Las distribuciones que cambian son:

- Paterna - CEAM: Tiene una distribución normal.
- Massanassa_UM y Sedavi UM: tienen un pico de valores extremos a la izquierda y muy pocos a la derecha.

Aún así, con esta información no tenemos pruebas suficientes como para sacar conclusiones definitivas sobre la presencia de dos poblaciones. Vamos a ver cómo se distribuye el O3 a lo largo del tiempo para profundizar más.

### Comportamiento general a lo largo del tiempo 

```{r}
# Ver distribución general para la variable O3 en el tiempo
ggplot(df_NOs, aes(x = FechaHora)) +
  geom_line(aes(y = O3, color = "O3")) +
  labs(title = "O3 a lo largo del tiempo",
       x = "Fecha y Hora",
       y = "Concentración (µg/m³)",
       color = "Contaminante") +
  theme_minimal()
```

Viendo el comportamiento del $O_3$ a lo largo del tiempo tampoco encontramos una explicación a la distribución bimodal. Sin embargo, sí que vemos que el ozono tiene un comportamiento estacional, con picos en verano y mínimos en invierno. Esto es debido a la formación de ozono troposférico, que se produce por la reacción de los óxidos de nitrógeno y los compuestos orgánicos volátiles en presencia de luz solar. Al realizar el cruce con los factores meteorológicos comprobaremos esta hipótesis.

Vamos a ver la distribución del ozono dependiendo de si es invierno o verano.

### Distribución por épocas estacionales

```{r}
df_NOs_verano <- df_NOs %>%
  filter(month(FechaHora) %in% 4:9)

meses_restantes = setdiff(1:12, 4:9)
df_NOs_invierno <- df_NOs %>%
  filter(month(FechaHora) %in% meses_restantes)
unique(month(df_NOs_invierno$FechaHora))
```



```{r}
hist((df_NOs_verano$O3), breaks = 100, main = "Distribución de O3", xlab = "O3", ylab = "Frecuencia")
hist((df_NOs_invierno$O3), breaks = 100, main = "Distribución de O3", xlab = "O3", ylab = "Frecuencia")
```

Ahora sí que vemos que las dos poblaciones se corresponden a los meses de verano y a los de invierno. En verano la distribución es normal, mientras que en invierno la distribución es bimodal. La teoría es que el ozono se forma por la reacción de los óxidos de nitrógeno y los compuestos orgánicos volátiles en presencia de luz solar, y en invierno la radiación solar es menor, lo que provoca que la formación de ozono sea menor. Más adelante intentaremos validar esta hipótesis cruzando el ozono con los factores meteorológicos y con otros contaminantes.

Como aún no podemos comprender el comportamiento del ozono en la época de invierno, vamos a centrarnos en la época de verano. En este caso, la distribución es normal y no tiene valores atípicos.


## Comportamiento a lo largo del tiempo

Este comportamiento ya lo hemos estudiado antes para darle una explicación a la distribución bimodal. Así, vamos a pasar directamente a estudiar el tiempo granularmente

### Años

```{r}
df_O3_anual <- df_NOs %>%
  group_by(year = year(FechaHora)) %>%
  summarise(across(c("O3"), mean, na.rm = TRUE)) %>%
  filter(!is.na(year)) %>%
  ungroup()
```

```{r}
ggplot(df_O3_anual, aes(x = year, y = O3)) +
  geom_area(fill = "#6EC6FF", alpha = 0.4) +
  geom_line(color = "#4682B4", size = 1.2) +
  geom_point(color = "#4682B4", size = 3) +
  scale_x_continuous(breaks = 2019:2024, limits = c(2019, 2024)) +
  labs(
    title    = "Evolución anual de la concentración media de O3",
    subtitle = "Valores medios de todas las estaciones en Valencia",
    x        = "Año",
    y        = "Concentración media de O3 (µg/m³)",
    caption  = "Source: your air pollution data"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background  = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_blank(),
    axis.title       = element_text(face = "bold"),
    axis.text        = element_text(color = "gray20"),
    plot.title       = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle    = element_text(color = "gray40", hjust = 0.5),
    plot.caption     = element_text(size = 8, color = "gray60")
  )
```

Vemos como apenas hay cambios en la concentración de ozono a lo largo de los años, a excepción de 2020 que ya sabemos que fue un año atípico por el COVID-19. Aún así, se ve una ligera tendencia decreciente en la concentración de ozono a lo largo de los años. Vamos a comprobar estadísticamente si esta tendencia es significativa o no mediante un anova

#### ANOVA

```{r}
anova_O3 <- aov(O3 ~ year, data = df_O3_anual)
summary(anova_O3)
```

```{r}
par(mfrow = c(1, 1))
plot(anova_O3)
```

```{r}
dw <- dwtest(anova_O3)
print(dw)
```

Vemos que se cumplen las hipótesis inciales del anova, y que además el test F no significativo. Por lo tanto, aceptamos $H_0$ y no hay diferencias significativas entre los años. Esto es consistente con lo que hemos visto en el gráfico de la evolución anual de la concentración media de ozono.


### Meses

```{r}
df_O3_mensual <- df_NOs %>%
  group_by(month = month(FechaHora, label = TRUE)) %>%
  summarise(across(c("O3"), mean, na.rm = TRUE)) %>%
  filter(!is.na(month)) %>%
  ungroup()
```

```{r}
ggplot(df_O3_mensual, aes(x = month, y = O3, group = 1)) +
  geom_area(fill = "#6EC6FF", alpha = 0.4) +
  geom_line(color = "#4682B4", size = 1.2) +
  geom_point(color = "#4682B4", size = 3) +
  labs(
    title    = "Evolución media mensual de la concentración de O3",
    subtitle = "Media agregada sobre todos los años",
    x        = "Mes",
    y        = "Concentración media de O3 (µg/m³)",
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.background  = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "#f7f7f7", color = NA),
    panel.grid.major = element_line(color = "gray80"),
    panel.grid.minor = element_blank(),
    axis.title       = element_text(face = "bold"),
    axis.text        = element_text(color = "gray20"),
    plot.title       = element_text(face = "bold", size = 16, hjust = 0.5),
    plot.subtitle    = element_text(color = "gray40", hjust = 0.5),
    plot.caption     = element_text(size = 8, color = "gray60")
  )
```

La concentración de O3 tiene su pico en los meses de abril, mayo y junio, y a partir de estos los valores, la media mensual va descendiendo hasta alcanzar los mínimos en los meses de enero y diciembre. Esto confirma la hipótesis de que hay dos poblaciones de ozono, una en verano y otra en invierno.


### Días

```{r}
df_O3_semanal <- df_NOs %>%
  # crear weekday y eliminar filas con FechaHora NA
  mutate(
    weekday = wday(FechaHora,
                   label      = TRUE,
                   abbr       = TRUE,
                   week_start = 1)
  ) %>%
  filter(!is.na(weekday)) %>%      # quitar el nivel que corresponde a NA
  group_by(weekday) %>%
  summarise(
    O3 = mean(O3, na.rm = TRUE),
    .groups = "drop"
  )
```


```{r}
ggplot(df_O3_semanal, aes(x = weekday, y = O3, group = 1)) +
  geom_area(fill = "#6EC6FF", alpha = 0.4) +
  geom_line(color = "#4682B4", size = 1.2) +
  geom_point(color = "#4682B4", size = 3) +
  labs(
    title = "Concentración media de O3 por día de la semana",
    x     = "Día de la semana",
    y     = "Concentración media de O3 (µg/m³)"
  ) +
  theme_minimal(base_size = 14)
```

Como se dice en la información estudiada, los fines de semana la concentración de ozono es mucho más baja que entre semana. Además, entre semana se mantienen constantes los valores.


### Horas

```{r}
df_O3_horario <- df_NOs %>%
  # crear weekday y eliminar filas con FechaHora NA
  mutate(
    hour = hour(FechaHora)
  ) %>%
  filter(!is.na(hour)) %>%      # quitar el nivel que corresponde a NA
  group_by(hour) %>%
  summarise(
    O3 = mean(O3, na.rm = TRUE),
    .groups = "drop"
  )
```


```{r}
ggplot(df_O3_horario, aes(x = hour, y = O3, group = 1)) +
  geom_area(fill = "#6EC6FF", alpha = 0.4) +
  geom_line(color = "#4682B4", size = 1.2) +
  geom_point(color = "#4682B4", size = 3) +
  labs(
    title = "Concentración media de O3 por hora del día",
    x     = "Hora del día",
    y     = "Concentración media de O3 (µg/m³)"
  ) +
  theme_minimal(base_size = 14)
```

En el comportamiento del $O_3$ por horas vemos como hay una clara tendencia: la concentración de $O_3$ tiende a aumentar cuando aumenta la radiación solar, y a disminuir cuando disminuye. Esto es consistente con lo que hemos visto en la distribución del ozono a lo largo del tiempo y con la teoría de que el ozono se forma por la reacción de los óxidos de nitrógeno y los compuestos orgánicos volátiles en presencia de luz solar.

## Comportamiento de los valores faltantes

Antes de pasar a estudiar el comportamiento por zonas, vamos a ver cómo se comportan los valores faltantes de estos contaminantes. Entendiendo esto, podríamos hacer una imputación correcta y precisa de los faltantes para potenciar posteriormente el análisis.

En primer lugar, vamos a ver el porcentaje de faltantes que tenemos para $O_3$.

```{r}
df_NOs %>% summarise(across(c("O3"), ~ sum(is.na(.)) / n() * 100))
```

El porcentaje de faltantes no es demasiado alto. Vamos a profundizar un poco más en el análisis de los valores faltantes viendo como se distribuyen por zonas. 

### Faltantes por zonas

```{r}
missing_values_zona_O3 <- df_NOs %>%
  group_by(Origen) %>%
  summarise(
    Porcentaje_Faltantes = sum(is.na(O3)) / n() * 100,
    .groups = "drop"
  ) %>%
  arrange(Porcentaje_Faltantes, Origen)

missing_values_zona_O3
```

Vemos que en general hay muy pocos faltantes para todas las estaciones (< 5%). Sin embargo las estaciones de *Benetusser UM*, *Catarroja UM*, *Paiporta UM*, *València - Centre* y *València Olivereta* no registran ningún dato de ozono. Por lo tanto, para el análisis de estos contaminantes no vamos a considerar estas estaciones.

```{r}
df_O3 = df_NOs %>%
  filter(Origen != "Benetusser UM" & Origen != "Catarroja UM" & Origen != "Paiporta UM" & Origen != "València - Centre" & Origen != "València Olivereta")
```


### Distribución de los valores faltantes

Vamos a ver cómo se distribuyen los valores faltantes de estos contaminantes a lo largo del tiempo, con el objetivo de detectar si hay algún patrón en la distribución de los valores faltantes.

```{r}
df_O3 %>%
  mutate(missing = is.na(O3)) %>%
  ggplot(aes(x = FechaHora, y = Origen, fill = missing)) +
  geom_tile() +
  scale_fill_manual(values = c(`TRUE` = "red", `FALSE` = "grey90")) +
  labs(title = "Dónde y cuándo faltan valores de O3",
       x = "Fecha y hora", y = "Zona",
       fill = "Es NA") +
  theme_minimal()
```

A la vista del gráfico no podemos afirmar la existencia de ningún patrón de faltantes ni entre estaciones ni a lo largo del tiempo. Además vemos que las estaciones de "Sedavi UM" y "Massanassa_UM" tienen una muestra insignificante de datos, por lo que no las vamos a considerar para el análisis posterior.

```{r}
df_O3 = df_O3 %>%
  filter(Origen != "Sedavi UM" & Origen != "Massanassa_UM")
```


## Comportamiento por zonas

Vamos a intentar entender el comportamiento de estas variables en las distintas zonas donde se miden. 

Para ellos vamos a realizar un ANOVA intentando ver si hay alguna diferencia significativa entre zonas.

### ANOVA

Como hemos visto en la distribución, vamos a coger un día de verano y eliminar la dimensión tiempo. Además, no hace falta en principio hacerle ninguna transformación a la variable porque la distribución es normal y no tiene valores atípicos. Por lo tanto, vamos a realizar el anova directamente con la variable $O_3$ y eliminando la dimensión del tiempo.

```{r}
df_O3_2023 = df_O3 %>%
  filter(FechaHora >= "2023-04-01" & FechaHora < "2023-10-01") %>%
  filter(hour(FechaHora) == 12) %>%
  filter(wday(FechaHora) == 2) %>%
  sample_n(20)

anova_O3_2023 <- aov(O3 ~ Origen, data = df_O3_2023)
summary(anova_O3_2023)
```

```{r}
par(mfrow = c(1, 1))
plot(anova_O3_2023)
```

```{r}
dw <- dwtest(anova_O3_2023)
print(dw)
```

```{r}
leveneTest(anova_O3_2023)
```

Como se han validado las tres hipótesis del anova y además el test F ha resultado no significativo, aceptamos $H_0$ y no hay diferencias significativas entre las estaciones. Esto es consistente con lo que hemos visto en la distribución de los valores de ozono a lo largo del tiempo y por estaciones. Por lo tanto, no vamos a realizar el test de Tukey.


## Conclusiones

- Podemos concluir que el ozono tiene un comportamiento estacional, con picos en verano y mínimos en invierno, y que su concentración aumenta durante el día y disminuye durante la noche. 

- Además, no hay diferencias significativas entre las estaciones.

- Por último, los valores faltantes no siguen ningún patrón concreto.